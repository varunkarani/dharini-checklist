<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dharini Daily Checklist</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<style>
body{font-family:system-ui;background:#f6f7fb;margin:0;padding:16px}
h2{margin-top:0}
.nav{margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
.blockTitle{font-weight:900;margin-bottom:10px}
.task{margin-bottom:12px}
input{padding:6px;border-radius:6px;border:1px solid #ddd;margin:4px}
button{padding:8px 12px;border-radius:8px;border:0;background:#2f6fed;color:#fff;font-weight:800}
button.ghost{background:#eef0f6;color:#111}
.progress{height:8px;background:#e8eaf2;border-radius:999px;overflow:hidden;margin-bottom:8px}
.progress div{height:100%;background:#2f6fed;width:0%}
.small{font-size:12px;opacity:.75}
hr{border:none;border-top:1px solid #eee;margin:12px 0}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ddd;padding:8px;font-size:12px;vertical-align:top}
th{background:#f5f5f5;text-align:left}
.pdfWrap{background:#fff;padding:16px}
.badge{display:inline-block;background:#111;color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
</style>
</head>

<body>

<h2>Dharini Daily Checklist</h2>

<div class="nav">
  <button onclick="shiftDay(-1)">◀ Previous</button>
  <input type="date" id="datePicker">
  <button onclick="shiftDay(1)">Next ▶</button>
</div>

<div class="progress"><div id="bar"></div></div>
<div id="percent"></div>

<div id="app"></div>

<div class="card">
  <h3>Trends (Last 30 Days)</h3>
  <canvas id="bpChart"></canvas>
  <canvas id="sugarChart"></canvas>
</div>

<div class="card">
  <h3>Export</h3>
  <div class="small">Tip: “All previous days” can be heavy on iPad if you have a lot of days. If it fails, use Last 30 Days.</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
    <button onclick="exportSelectedDayPDF()">Export Selected Day (PDF)</button>
    <button class="ghost" onclick="exportSelectedPlusPreviousPDF()">Export Selected + All Previous (PDF)</button>
    <button class="ghost" onclick="exportLastNDaysPDF(30)">Export Last 30 Days (PDF)</button>
  </div>
</div>

<!-- Hidden container for PDF rendering -->
<div id="pdfContainer" style="position:absolute;left:-99999px;top:-99999px;width:800px"></div>

<script>
/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAxjeAx9iMHomGppnnouaJ5ISR3AthNEvU",
  authDomain: "dharini-checklist-sync.firebaseapp.com",
  projectId: "dharini-checklist-sync",
  storageBucket: "dharini-checklist-sync.firebasestorage.app",
  messagingSenderId: "428971704286",
  appId: "1:428971704286:web:bd52c5bb86c9ed3725674f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= SETTINGS ================= */

const BOARD_ID="dharini-global-board";
const TIMEZONE="Asia/Kolkata";
const CEFHUM_END="2026-02-20";
let selectedDate=getISTDate();

/* ================= HELPERS ================= */

function getISTDate(dateObj=null){
  const now=dateObj||new Date();
  const ist=new Date(now.toLocaleString("en-US",{timeZone:TIMEZONE}));
  return ist.toISOString().split("T")[0];
}

function shiftDay(days){
  const d=new Date(selectedDate);
  d.setDate(d.getDate()+days);
  selectedDate=getISTDate(d);
  loadDay();
}

function afterEnd(date){return date>CEFHUM_END;}
function isSunday(date){return new Date(date).getDay()===0;}

function visibleTasksForDate(block, date){
  return block.tasks.filter(t => !t.show || t.show(date));
}

function calcCompletionForDate(data, date){
  let total=0, done=0;
  blocks.forEach(b=>{
    visibleTasksForDate(b,date).forEach(t=>{
      total++;
      if(data?.[t.id]?.done) done++;
    });
  });
  const percent = total ? Math.round((done/total)*100) : 0;
  return { total, done, percent };
}

function safeNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

/* ================= FULL CHECKLIST ================= */

const blocks=[
{
title:"Before Breakfast",
tasks:[
{id:"bb_bp",text:"Measure BP",type:"bp"},
{id:"bb_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bb_novo10",text:"Novorapid 10u"},
{id:"bb_panD",text:"Pan D"}
]},
{
title:"After Breakfast",
tasks:[
{id:"ab_cefhum",text:"Cefhum",show:(d)=>!afterEnd(d)},
{id:"ab_metxl",text:"Met XL"},
{id:"ab_nikoran",text:"Nikoran"},
{id:"ab_lasilactone",text:"Lasilactone"},
{id:"ab_cobadex",text:"Cobadex"},
{id:"ab_folic",text:"Folic Acid"},
{id:"ab_ivabred",text:"Ivabred"},
{id:"ab_dolo",text:"Dolo (optional)"},
{id:"ab_vitd",text:"Vit D (Sunday only)",show:(d)=>isSunday(d)}
]},
{
title:"Before Lunch",
tasks:[
{id:"bl_bp",text:"Measure BP",type:"bp"},
{id:"bl_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bl_novo12",text:"Novorapid 12u"}
]},
{
title:"After Lunch",
tasks:[
{id:"al_ecosprin",text:"Ecosprin"},
{id:"al_clopitab",text:"Clopitab"}
]},
{
title:"Before Dinner",
tasks:[
{id:"bd_bp",text:"Measure BP",type:"bp"},
{id:"bd_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bd_novo7",text:"Novorapid 7u"}
]},
{
title:"After Dinner Meds",
tasks:[
{id:"ad_cefhum",text:"Cefhum",show:(d)=>!afterEnd(d)},
{id:"ad_halfmet",text:"½ Met XL"},
{id:"ad_nikoran",text:"Nikoran"},
{id:"ad_ivabred",text:"Ivabred"}
]},
{
title:"2 Hours After Dinner",
tasks:[
{id:"2h_bp",text:"Measure BP",type:"bp"},
{id:"2h_sugar",text:"Measure Sugar",type:"sugar"},
{id:"2h_tresiba",text:"Tresiba 16u"},
{id:"2h_dolo",text:"Dolo (if pain)"},
{id:"2h_rosuva",text:"Rosuvastatin"}
]}
];

/* ================= LOAD DAY ================= */

let unsubscribe=null;

function loadDay(){
  if(unsubscribe)unsubscribe();

  document.getElementById("datePicker").value=selectedDate;

  const docRef=db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .doc(selectedDate);

  unsubscribe=docRef.onSnapshot(doc=>{
    render(doc.data()||{},docRef);
  });

  loadTrends();
}

/* ================= RENDER UI ================= */

function render(data,docRef){

  const app=document.getElementById("app");
  app.innerHTML="";
  let total=0,done=0;

  blocks.forEach(block=>{
    const card=document.createElement("div");
    card.className="card";

    const title=document.createElement("div");
    title.className="blockTitle";
    title.textContent=block.title;
    card.appendChild(title);

    visibleTasksForDate(block, selectedDate).forEach(task=>{
      total++;

      const row=document.createElement("div");
      row.className="task";

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked=data?.[task.id]?.done||false;
      if(cb.checked)done++;

      cb.onchange=()=>{
        docRef.set({
          [task.id]:{...data?.[task.id],done:cb.checked}
        },{merge:true});
      };

      row.appendChild(cb);
      row.append(" "+task.text);

      if(task.type==="bp"){
        const sys=document.createElement("input");
        sys.placeholder="Sys";
        sys.value=data?.[task.id]?.sys||"";

        const dia=document.createElement("input");
        dia.placeholder="Dia";
        dia.value=data?.[task.id]?.dia||"";

        const save=document.createElement("button");
        save.textContent="Save BP";
        save.onclick=()=>{
          docRef.set({
            [task.id]:{
              done:true,
              sys:sys.value,
              dia:dia.value
            }
          },{merge:true});
        };

        row.appendChild(document.createElement("br"));
        row.appendChild(sys);
        row.appendChild(dia);
        row.appendChild(save);

        const last = (data?.[task.id]?.sys && data?.[task.id]?.dia) ? `${data[task.id].sys}/${data[task.id].dia}` : "—";
        row.appendChild(document.createElement("br"));
        row.appendChild(smallText("Saved: "+last));
      }

      if(task.type==="sugar"){
        const val=document.createElement("input");
        val.placeholder="Sugar";
        val.value=data?.[task.id]?.value||"";

        const save=document.createElement("button");
        save.textContent="Save Sugar";
        save.onclick=()=>{
          docRef.set({
            [task.id]:{
              done:true,
              value:val.value
            }
          },{merge:true});
        };

        row.appendChild(document.createElement("br"));
        row.appendChild(val);
        row.appendChild(save);

        const last = data?.[task.id]?.value ? data[task.id].value : "—";
        row.appendChild(document.createElement("br"));
        row.appendChild(smallText("Saved: "+last));
      }

      card.appendChild(row);
    });

    app.appendChild(card);
  });

  const percent=Math.round((done/total)*100)||0;
  document.getElementById("bar").style.width=percent+"%";
  document.getElementById("percent").textContent=percent+"% Complete ("+selectedDate+")";
}

function smallText(t){
  const s=document.createElement("div");
  s.className="small";
  s.textContent=t;
  return s;
}

/* ================= TRENDS ================= */

let bpChart = null;
let sugarChart = null;

async function loadTrends(){

  const snapshot=await db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .limitToLast(30)
    .get();

  const labels=[];
  const sys=[];
  const dia=[];
  const sugar=[];

  snapshot.forEach(doc=>{
    const d=doc.data();
    labels.push(doc.id);

    // Prefer bb_bp/bb_sugar as the "morning baseline"
    sys.push(safeNum(d?.bb_bp?.sys));
    dia.push(safeNum(d?.bb_bp?.dia));
    sugar.push(safeNum(d?.bb_sugar?.value));
  });

  if(bpChart) bpChart.destroy();
  if(sugarChart) sugarChart.destroy();

  bpChart = new Chart(document.getElementById("bpChart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Systolic",data:sys},
        {label:"Diastolic",data:dia}
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:true}}
    }
  });

  sugarChart = new Chart(document.getElementById("sugarChart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Sugar",data:sugar}
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:true}}
    }
  });
}

/* ================= PDF EXPORT ================= */

async function fetchDayDoc(date){
  const doc = await db.collection("boards").doc(BOARD_ID).collection("days").doc(date).get();
  return { date, data: doc.exists ? doc.data() : {} };
}

function buildDayTableHTML(dayObj){
  const date = dayObj.date;
  const data = dayObj.data || {};
  const c = calcCompletionForDate(data, date);

  let html = `
    <div style="margin-bottom:18px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
        <h3 style="margin:0;">${date}</h3>
        <span class="badge">${c.percent}% complete</span>
      </div>
      <div class="small">Done: ${c.done} / ${c.total}</div>
      <hr/>
  `;

  blocks.forEach(block=>{
    const tasks = visibleTasksForDate(block, date);
    html += `<h4 style="margin:10px 0 6px;">${block.title}</h4>`;
    html += `<table><tr><th>Task</th><th>Status</th><th>Reading</th></tr>`;

    tasks.forEach(t=>{
      const entry = data?.[t.id] || {};
      const status = entry.done ? "Done" : "Not done";

      let reading = "";
      if(t.type === "bp"){
        reading = (entry.sys && entry.dia) ? `${entry.sys}/${entry.dia}` : "";
      }
      if(t.type === "sugar"){
        reading = entry.value ? `${entry.value}` : "";
      }

      html += `<tr>
        <td>${t.text}</td>
        <td>${status}</td>
        <td>${reading || ""}</td>
      </tr>`;
    });

    html += `</table>`;
  });

  html += `</div>`;
  return html;
}

async function exportSelectedDayPDF(){
  const day = await fetchDayDoc(selectedDate);
  await exportDaysToPDF([day], `Dharini_${selectedDate}.pdf`);
}

async function exportSelectedPlusPreviousPDF(){
  // Fetch all docs up to selectedDate
  // Note: documentId is YYYY-MM-DD so lexicographic ordering works.
  const snap = await db.collection("boards").doc(BOARD_ID).collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .endAt(selectedDate)
    .get();

  const days = [];
  snap.forEach(doc => days.push({ date: doc.id, data: doc.data() }));

  await exportDaysToPDF(days, `Dharini_Upto_${selectedDate}.pdf`);
}

async function exportLastNDaysPDF(n){
  const snap = await db.collection("boards").doc(BOARD_ID).collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .limitToLast(n)
    .get();

  const days = [];
  snap.forEach(doc => days.push({ date: doc.id, data: doc.data() }));

  const first = days.length ? days[0].date : "start";
  await exportDaysToPDF(days, `Dharini_${first}_to_${selectedDate}_Last${n}.pdf`);
}

async function exportDaysToPDF(days, filename){
  const container = document.getElementById("pdfContainer");
  container.innerHTML = "";

  const wrap = document.createElement("div");
  wrap.className = "pdfWrap";

  wrap.innerHTML = `
    <h2 style="margin-top:0;">Dharini Checklist Report</h2>
    <div class="small">Generated: ${new Date().toLocaleString()}</div>
    <div class="small">Report includes: ${days.length} day(s)</div>
    <hr/>
  `;

  for(const day of days){
    wrap.innerHTML += buildDayTableHTML(day);
  }

  container.appendChild(wrap);

  const opt = {
    margin:       10,
    filename:     filename,
    image:        { type: 'jpeg', quality: 0.95 },
    html2canvas:  { scale: 2, useCORS: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['css', 'legacy'] }
  };

  await html2pdf().set(opt).from(wrap).save();
}

/* ================= BOOT ================= */

document.getElementById("datePicker").onchange=e=>{
  selectedDate=e.target.value;
  loadDay();
};

loadDay();
</script>

</body>
</html>
