<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dharini Daily Checklist</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<!-- Reliable PDF generation (data-driven, not screenshot-driven) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

<style>
/* ========= THEME TOKENS ========= */
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:rgba(15,23,42,.75);
  --shadow:0 6px 24px rgba(0,0,0,.06);
  --border:#dddddd;
  --borderSoft:#eeeeee;
  --primary:#2f6fed;
  --btnText:#ffffff;
  --ghostBg:#eef0f6;
  --ghostText:#111111;
  --chipBg:#111111;
  --chipText:#ffffff;
  --progressBg:#e8eaf2;
  --progressFill:#2f6fed;
  --inputBg:#ffffff;
  --danger:#d62c2c;
  --warn:#b45309;
  --ok:#0f9d58;
}

html[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f1a2d;
  --text:#e6edf7;
  --muted:rgba(230,237,247,.72);
  --shadow:0 10px 28px rgba(0,0,0,.45);
  --border:rgba(230,237,247,.16);
  --borderSoft:rgba(230,237,247,.10);
  --primary:#4c8dff;
  --btnText:#ffffff;
  --ghostBg:rgba(230,237,247,.10);
  --ghostText:#e6edf7;
  --chipBg:rgba(230,237,247,.14);
  --chipText:#e6edf7;
  --progressBg:rgba(230,237,247,.10);
  --progressFill:#4c8dff;
  --inputBg:rgba(230,237,247,.06);
  --danger:#ff6b6b;
  --warn:#ffb020;
  --ok:#44d07f;
}

/* ========= BASE ========= */
body{font-family:system-ui;background:var(--bg);color:var(--text);margin:0;padding:16px}
h2{margin:0 0 12px 0}
.nav{margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:var(--shadow);border:1px solid var(--borderSoft)}
.blockTitle{font-weight:900;margin-bottom:10px}
.task{margin-bottom:12px}
input,textarea,select{
  padding:10px;border-radius:10px;border:1px solid var(--border);
  margin:4px;background:var(--inputBg);color:var(--text);font-size:16px
}
input::placeholder, textarea::placeholder{color:var(--muted)}
button,.btn{
  padding:10px 14px;border-radius:10px;border:0;background:var(--primary);
  color:var(--btnText);font-weight:800;display:inline-block;text-decoration:none
}
button.ghost,.btn.ghost{background:var(--ghostBg);color:var(--ghostText)}
button:disabled{opacity:.55}
.progress{height:8px;background:var(--progressBg);border-radius:999px;overflow:hidden;margin-bottom:8px}
.progress div{height:100%;background:var(--progressFill);width:0%}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid var(--borderSoft);margin:12px 0}
.rowActions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* Theme toggle button */
.themeBtn{
  display:inline-flex;align-items:center;gap:8px;
  padding:10px 14px;border-radius:10px;border:1px solid var(--borderSoft);
  background:var(--ghostBg);color:var(--ghostText);font-weight:800;
}
.themeDot{width:10px;height:10px;border-radius:999px;background:var(--progressFill)}

/* Today-at-a-glance */
.stickyTop{
  position:sticky;top:0;z-index:50;
  background:linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0)) , var(--bg);
  padding-top:8px;
}
.topCard{
  background:var(--card);
  border:1px solid var(--borderSoft);
  border-radius:12px;
  padding:12px;
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;
  border:1px solid var(--borderSoft);
  background:var(--ghostBg);
  font-weight:800;font-size:12px;
}
.pill.danger{background:rgba(214,44,44,.12);border-color:rgba(214,44,44,.22);color:var(--danger)}
.pill.warn{background:rgba(180,83,9,.12);border-color:rgba(180,83,9,.22);color:var(--warn)}
.pill.ok{background:rgba(15,157,88,.12);border-color:rgba(15,157,88,.22);color:var(--ok)}
.kpiRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.kpiLeft{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.kpiRight{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.missList{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
.missItem{
  padding:8px 10px;border-radius:10px;border:1px solid var(--borderSoft);
  background:var(--card);
  font-weight:800;font-size:12px;
}
.missItem.danger{border-color:rgba(214,44,44,.32);color:var(--danger)}
.missItem.warn{border-color:rgba(180,83,9,.32);color:var(--warn)}
/* Big keypad inputs */
.bigInputs{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
.bigInputs input{width:110px;font-size:20px;padding:12px 12px}
.bigInputs input.narrow{width:95px}
.bigInputs .hint{flex-basis:100%}

/* Abnormal highlight */
.readingTag{
  display:inline-block;
  padding:4px 8px;border-radius:999px;
  border:1px solid var(--borderSoft);
  font-size:12px;font-weight:900;
  margin-left:8px;
}
.readingTag.danger{border-color:rgba(214,44,44,.35);color:var(--danger)}
.readingTag.warn{border-color:rgba(180,83,9,.35);color:var(--warn)}
.readingTag.ok{border-color:rgba(15,157,88,.35);color:var(--ok)}
</style>
</head>

<body>

<div class="stickyTop">
  <h2>Dharini Daily Checklist</h2>

  <div class="nav">
    <button onclick="shiftDay(-1)">◀ Previous</button>
    <input type="date" id="datePicker">
    <button onclick="shiftDay(1)">Next ▶</button>

    <a class="btn ghost" href="https://www.icloud.com/shortcuts/e5923e2e7c014ae5b8478bd3cb6326fb" target="_blank" rel="noopener">
      Add Reminders to phone
    </a>

    <button class="themeBtn" id="themeToggle" type="button" onclick="toggleTheme()">
      <span class="themeDot"></span>
      <span id="themeLabel">Theme</span>
    </button>
  </div>

  <!-- Today at a glance -->
  <div class="topCard" id="todayAtGlance">
    <div class="kpiRow">
      <div class="kpiLeft">
        <span class="pill" id="kpiCompletion">—</span>
        <span class="pill" id="kpiNext">Next: —</span>
      </div>
      <div class="kpiRight">
        <button class="ghost" onclick="jumpToNextMissing()">Jump to next missing</button>
      </div>
    </div>
    <div class="missList" id="missList"></div>
  </div>

  <div class="progress"><div id="bar"></div></div>
  <div id="percent"></div>
</div>

<div id="app"></div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Comments (for selected day)</h3>
  <div class="small">Symptoms, missed dose reason, appetite, sleep, doctor notes.</div>
  <textarea id="dayComments" rows="5" style="width:100%;margin-top:10px"></textarea>
  <div class="small" id="commentsStatus"></div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Trends</h3>
  <div class="rowActions" style="margin-bottom:10px">
    <span class="small" style="font-weight:900">Chart slot:</span>
    <select id="slotSelect" onchange="loadTrends()">
      <option value="bb">Before Breakfast</option>
      <option value="bl">Before Lunch</option>
      <option value="bd">Before Dinner</option>
      <option value="2h">2 Hours After Dinner</option>
    </select>
    <span class="small">Shows the selected slot across the last 30 days.</span>
  </div>
  <canvas id="bpChart"></canvas>
  <div style="height:10px"></div>
  <canvas id="sugarChart"></canvas>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Export</h3>
  <div class="small">
    Exports all entries from <b>Feb 14, 2026</b> onwards up to the selected date (inclusive), including all BP/Sugar readings and Comments.
  </div>
  <div class="rowActions" style="margin-top:10px">
    <button id="exportBtn" onclick="exportToPDF()">Export to PDF</button>
    <span class="small" id="exportStatus"></span>
  </div>
</div>

<div class="card" style="text-align:center">
  <div class="small">
    Last Edited:
    <span id="lastEditedValue">—</span>
  </div>
</div>

<script>
/* ================= THEME (DARK MODE) ================= */

function getSavedTheme(){ return localStorage.getItem("theme") || "system"; }

function getSystemTheme(){
  return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
}

function applyTheme(theme){
  const effective = theme === "system" ? getSystemTheme() : theme;
  document.documentElement.setAttribute("data-theme", effective);

  const label = document.getElementById("themeLabel");
  if(label){
    if(theme === "system") label.textContent = "Theme: System";
    if(theme === "dark") label.textContent = "Theme: Dark";
    if(theme === "light") label.textContent = "Theme: Light";
  }
}

function toggleTheme(){
  const current = getSavedTheme();
  const next = current === "system" ? "dark" : (current === "dark" ? "light" : "system");
  localStorage.setItem("theme", next);
  applyTheme(next);
  loadTrends();
}

if(window.matchMedia){
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ()=>{
    if(getSavedTheme() === "system"){
      applyTheme("system");
      loadTrends();
    }
  });
}

function isDarkNow(){ return document.documentElement.getAttribute("data-theme") === "dark"; }
function chartTextColor(){ return isDarkNow() ? "rgba(230,237,247,.85)" : "rgba(15,23,42,.85)"; }
function chartGridColor(){ return isDarkNow() ? "rgba(230,237,247,.12)" : "rgba(15,23,42,.12)"; }

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAxjeAx9iMHomGppnnouaJ5ISR3AthNEvU",
  authDomain: "dharini-checklist-sync.firebaseapp.com",
  projectId: "dharini-checklist-sync",
  storageBucket: "dharini-checklist-sync.firebasestorage.app",
  messagingSenderId: "428971704286",
  appId: "1:428971704286:web:bd52c5bb86c9ed3725674f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= SETTINGS ================= */

const BOARD_ID="dharini-global-board";
const TIMEZONE="Asia/Kolkata";
const CEFHUM_END="2026-02-20";
const EXPORT_START_DATE="2026-02-14"; // inclusive

let selectedDate = getISTDate();
let activeDocRef = null;
let unsubscribe = null;
let commentsTimer = null;
let latestDayDataCache = {}; // used for at-a-glance, jump to next missing

/* ================= HELPERS ================= */

function getISTDate(dateObj=null){
  const now = dateObj || new Date();
  const ist = new Date(now.toLocaleString("en-US",{timeZone:TIMEZONE}));
  return ist.toISOString().split("T")[0];
}

function shiftDay(days){
  const d = new Date(selectedDate);
  d.setDate(d.getDate()+days);
  selectedDate = getISTDate(d);
  loadDay();
}

function afterEnd(date){ return date > CEFHUM_END; }
function isSunday(date){ return new Date(date).getDay() === 0; }

function safeNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

function updateLastEdited(){
  if(!activeDocRef) return;
  activeDocRef.set({
    __lastEdited: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
}

function renderLastEdited(data){
  const el = document.getElementById("lastEditedValue");
  if(!el) return;

  if(!data.__lastEdited){
    el.textContent = "No edits yet";
    return;
  }

  const ts = data.__lastEdited.toDate();
  el.textContent = ts.toLocaleString("en-IN", {
    timeZone: "Asia/Kolkata",
    dateStyle: "medium",
    timeStyle: "short"
  });
}

/* ================= CHECKLIST + SCHEDULE ================= */

const blocks = [
{
  title:"Before Breakfast",
  key:"bb",
  tasks:[
    { id:"bb_bp", text:"Measure BP", type:"bp"},
    { id:"bb_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bb_novo10", text:"Novorapid 10u"},
    { id:"bb_panD", text:"Pan D"}
  ]
},
{
  title:"After Breakfast",
  key:"ab",
  tasks:[
    { id:"ab_cefhum", text:"Cefhum", show:(d)=>!afterEnd(d)},
    { id:"ab_metxl", text:"Met XL"},
    { id:"ab_nikoran", text:"Nikoran"},
    { id:"ab_lasilactone", text:"Lasilactone"},
    { id:"ab_cobadex", text:"Cobadex"},
    { id:"ab_folic", text:"Folic Acid"},
    { id:"ab_ivabred", text:"Ivabred"},
    { id:"ab_dolo", text:"Dolo (optional)"},
    { id:"ab_vitd", text:"Vit D (Sunday only)", show:(d)=>isSunday(d)}
  ]
},
{
  title:"Before Lunch",
  key:"bl",
  tasks:[
    { id:"bl_bp", text:"Measure BP", type:"bp"},
    { id:"bl_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bl_novo12", text:"Novorapid 12u"}
  ]
},
{
  title:"After Lunch",
  key:"al",
  tasks:[
    { id:"al_ecosprin", text:"Ecosprin"},
    { id:"al_clopitab", text:"Clopitab"}
  ]
},
{
  title:"Before Dinner",
  key:"bd",
  tasks:[
    { id:"bd_bp", text:"Measure BP", type:"bp"},
    { id:"bd_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bd_novo7", text:"Novorapid 7u"}
  ]
},
{
  title:"After Dinner",
  key:"ad",
  tasks:[
    { id:"ad_cefhum", text:"Cefhum", show:(d)=>!afterEnd(d)},
    { id:"ad_halfmet", text:"½ Met XL"},
    { id:"ad_nikoran", text:"Nikoran"},
    { id:"ad_ivabred", text:"Ivabred"}
  ]
},
{
  title:"2 Hours After Dinner",
  key:"2h",
  tasks:[
    { id:"2h_bp", text:"Measure BP", type:"bp"},
    { id:"2h_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"2h_tresiba", text:"Tresiba 16u"},
    { id:"2h_dolo", text:"Dolo (optional)"},
    { id:"2h_rosuva", text:"Rosuvastatin"}
  ]
}
];

function visibleTasksForDate(block, date){
  return block.tasks.filter(t => !t.show || t.show(date));
}

function calcCompletionForDate(data, date){
  let total = 0, done = 0;
  blocks.forEach(b=>{
    visibleTasksForDate(b, date).forEach(t=>{
      total++;
      if(data?.[t.id]?.done) done++;
    });
  });
  const percent = total ? Math.round((done/total)*100) : 0;
  return { total, done, percent };
}

/* Schedule (for "today at a glance" + missed detection) */
const SCHEDULE = [
  { key:"bb", title:"Before Breakfast", hour:8, minute:0, requiredIds:["bb_bp","bb_sugar"] },
  { key:"ab", title:"After Breakfast",  hour:8, minute:30, requiredIds:[] },
  { key:"bl", title:"Before Lunch",     hour:13, minute:0, requiredIds:["bl_bp","bl_sugar"] },
  { key:"al", title:"After Lunch",      hour:13, minute:30, requiredIds:[] },
  { key:"bd", title:"Before Dinner",    hour:20, minute:0, requiredIds:["bd_bp","bd_sugar"] },
  { key:"ad", title:"After Dinner",     hour:20, minute:30, requiredIds:[] },
  { key:"2h", title:"2 Hours After Dinner", hour:22, minute:30, requiredIds:["2h_bp","2h_sugar"] }
];

function nowInIST(){
  return new Date(new Date().toLocaleString("en-US",{timeZone:TIMEZONE}));
}
function minutesSinceMidnight(d){
  return d.getHours()*60 + d.getMinutes();
}
function scheduledMinutes(item){ return item.hour*60 + item.minute; }

function nextCheckpointLabel(){
  const now = nowInIST();
  const m = minutesSinceMidnight(now);
  for(const s of SCHEDULE){
    if(scheduledMinutes(s) > m){
      return `Next: ${s.title} (${pad2(s.hour)}:${pad2(s.minute)})`;
    }
  }
  return "Next: Tomorrow (Before Breakfast)";
}
function pad2(n){ return String(n).padStart(2,"0"); }

/* Missed detection: if it's past checkpoint time + grace, and required readings not done */
const GRACE_MINUTES = 30;

function computeMissedBadges(data){
  const badges = [];
  const now = nowInIST();
  const nowM = minutesSinceMidnight(now);

  for(const s of SCHEDULE){
    if(!s.requiredIds || s.requiredIds.length === 0) continue;

    const dueM = scheduledMinutes(s) + GRACE_MINUTES;
    if(nowM < dueM) continue;

    for(const id of s.requiredIds){
      const entry = data?.[id] || {};
      if(!entry.done){
        badges.push({
          text: `${s.title}: ${id.includes("bp") ? "BP" : "Sugar"} missing`,
          severity: "danger",
          taskId: id
        });
      }
    }
  }

  return badges;
}

function jumpToNextMissing(){
  const missing = findNextMissingTask(latestDayDataCache);
  if(!missing){
    alert("Nothing missing right now.");
    return;
  }
  const el = document.getElementById("task_"+missing);
  if(el){
    el.scrollIntoView({ behavior:"smooth", block:"center" });
    el.style.outline = "3px solid rgba(76,141,255,.65)";
    setTimeout(()=>{ el.style.outline=""; }, 1800);
  }
}

function findNextMissingTask(data){
  for(const block of blocks){
    const tasks = visibleTasksForDate(block, selectedDate);
    for(const t of tasks){
      if(!data?.[t.id]?.done){
        return t.id;
      }
    }
  }
  return null;
}

/* Target ranges + flags (defaults; easy to tweak) */
const TARGETS = {
  bp_sys_high: 140,
  bp_dia_high: 90,
  sugar_low: 70,
  sugar_high: 180
};

function bpStatus(entry){
  const sys = safeNum(entry?.sys);
  const dia = safeNum(entry?.dia);
  if(sys === null && dia === null) return "none";
  if((sys !== null && sys >= TARGETS.bp_sys_high) || (dia !== null && dia >= TARGETS.bp_dia_high)) return "danger";
  return "ok";
}
function sugarStatus(entry){
  const v = safeNum(entry?.value);
  if(v === null) return "none";
  if(v < TARGETS.sugar_low) return "warn";
  if(v > TARGETS.sugar_high) return "danger";
  return "ok";
}

/* ================= LOAD DAY ================= */

function loadDay(){
  if(unsubscribe) unsubscribe();

  document.getElementById("datePicker").value = selectedDate;

  activeDocRef = db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .doc(selectedDate);

  unsubscribe = activeDocRef.onSnapshot(doc=>{
    const d = doc.data() || {};
    latestDayDataCache = d;
    render(d);
    loadCommentsIntoBox(d);
    renderLastEdited(d);
    renderAtAGlance(d);
  });

  loadTrends();
}

/* ================= TODAY AT A GLANCE ================= */

function renderAtAGlance(dayData){
  const c = calcCompletionForDate(dayData, selectedDate);

  const kpiCompletion = document.getElementById("kpiCompletion");
  if(kpiCompletion){
    kpiCompletion.textContent = `${c.percent}% complete (${c.done}/${c.total})`;
    kpiCompletion.className = "pill " + (c.percent >= 85 ? "ok" : (c.percent >= 50 ? "warn" : "danger"));
  }

  const kpiNext = document.getElementById("kpiNext");
  if(kpiNext){
    kpiNext.textContent = nextCheckpointLabel();
    kpiNext.className = "pill";
  }

  const missList = document.getElementById("missList");
  if(missList){
    missList.innerHTML = "";
    const missed = computeMissedBadges(dayData);

    if(missed.length === 0){
      const s = document.createElement("span");
      s.className = "pill ok";
      s.textContent = "No missed BP/Sugar checkpoints (so far)";
      missList.appendChild(s);
    } else {
      missed.forEach(m=>{
        const d = document.createElement("div");
        d.className = "missItem " + (m.severity === "danger" ? "danger" : "warn");
        d.textContent = m.text;
        d.onclick = ()=> {
          const el = document.getElementById("task_"+m.taskId);
          if(el) el.scrollIntoView({ behavior:"smooth", block:"center" });
        };
        missList.appendChild(d);
      });
    }
  }
}

/* ================= RENDER UI ================= */

function render(data){
  const app = document.getElementById("app");
  app.innerHTML = "";

  let total = 0, done = 0;

  blocks.forEach(block=>{
    const card = document.createElement("div");
    card.className = "card";

    const title = document.createElement("div");
    title.className = "blockTitle";
    title.textContent = block.title;
    card.appendChild(title);

    visibleTasksForDate(block, selectedDate).forEach(task=>{
      total++;

      const row = document.createElement("div");
      row.className = "task";
      row.id = "task_" + task.id;

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = data?.[task.id]?.done || false;
      if(cb.checked) done++;

      cb.onchange = ()=>{
        activeDocRef.set({
          [task.id]: { ...data?.[task.id], done: cb.checked }
        }, { merge:true });
        updateLastEdited();
      };

      row.appendChild(cb);
      row.append(" " + task.text);

      // Flag badge next to reading tasks
      if(task.type === "bp"){
        const st = bpStatus(data?.[task.id]);
        if(st !== "none"){
          const tag = document.createElement("span");
          tag.className = "readingTag " + st;
          tag.textContent = st === "danger" ? "High" : "OK";
          row.appendChild(tag);
        }
      }
      if(task.type === "sugar"){
        const st = sugarStatus(data?.[task.id]);
        if(st !== "none"){
          const tag = document.createElement("span");
          tag.className = "readingTag " + st;
          tag.textContent = st === "danger" ? "High" : (st === "warn" ? "Low" : "OK");
          row.appendChild(tag);
        }
      }

      if(task.type === "bp"){
        const sys = document.createElement("input");
        sys.placeholder = "Sys";
        sys.value = data?.[task.id]?.sys || "";
        sys.inputMode = "numeric";
        sys.type = "number";
        sys.className = "narrow";

        const dia = document.createElement("input");
        dia.placeholder = "Dia";
        dia.value = data?.[task.id]?.dia || "";
        dia.inputMode = "numeric";
        dia.type = "number";
        dia.className = "narrow";

        const pulse = document.createElement("input");
        pulse.placeholder = "Pulse";
        pulse.value = data?.[task.id]?.pulse || "";
        pulse.inputMode = "numeric";
        pulse.type = "number";
        pulse.className = "narrow";

        const save = document.createElement("button");
        save.textContent = "Save";
        save.onclick = ()=>{
          activeDocRef.set({
            [task.id]: {
              done: true,
              sys: sys.value,
              dia: dia.value,
              pulse: pulse.value
            }
          }, { merge:true });
          updateLastEdited();
        };

        const wrap = document.createElement("div");
        wrap.className = "bigInputs";
        wrap.appendChild(sys);
        wrap.appendChild(dia);
        wrap.appendChild(pulse);
        wrap.appendChild(save);

        const hint = document.createElement("div");
        hint.className = "small hint";
        hint.textContent = "Tip: tap a box and you’ll get the numeric keypad.";
        wrap.appendChild(hint);

        row.appendChild(document.createElement("br"));
        row.appendChild(wrap);
      }

      if(task.type === "sugar"){
        const val = document.createElement("input");
        val.placeholder = "Sugar";
        val.value = data?.[task.id]?.value || "";
        val.inputMode = "numeric";
        val.type = "number";

        const save = document.createElement("button");
        save.textContent = "Save";
        save.onclick = ()=>{
          activeDocRef.set({
            [task.id]: {
              done: true,
              value: val.value
            }
          }, { merge:true });
          updateLastEdited();
        };

        const wrap = document.createElement("div");
        wrap.className = "bigInputs";
        val.style.width = "140px";
        val.style.fontSize = "20px";
        val.style.padding = "12px 12px";
        wrap.appendChild(val);
        wrap.appendChild(save);

        const hint = document.createElement("div");
        hint.className = "small hint";
        hint.textContent = "Tip: tap the box and you’ll get the numeric keypad.";
        wrap.appendChild(hint);

        row.appendChild(document.createElement("br"));
        row.appendChild(wrap);
      }

      card.appendChild(row);
    });

    app.appendChild(card);
  });

  const percent = total ? Math.round((done/total)*100) : 0;
  document.getElementById("bar").style.width = percent + "%";
  document.getElementById("percent").textContent = percent + "% Complete (" + selectedDate + ")";
}

/* ================= COMMENTS ================= */

function loadCommentsIntoBox(dayData){
  const box = document.getElementById("dayComments");
  if(!box) return;

  const incoming = dayData.__comments || "";
  if(document.activeElement !== box && box.value !== incoming){
    box.value = incoming;
  }

  const status = document.getElementById("commentsStatus");
  if(status) status.textContent = "";
}

function wireCommentsAutosave(){
  const box = document.getElementById("dayComments");
  if(!box) return;

  box.addEventListener("input", ()=>{
    const status = document.getElementById("commentsStatus");
    if(status) status.textContent = "Saving…";

    if(commentsTimer) clearTimeout(commentsTimer);

    commentsTimer = setTimeout(async ()=>{
      try{
        if(!activeDocRef) return;
        await activeDocRef.set({
          __comments: box.value,
          __lastEdited: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        if(status) status.textContent = "Saved";
      } catch(e){
        if(status) status.textContent = "Save failed (check internet)";
      }
    }, 400);
  });
}

/* ================= TRENDS (ALL SLOTS) ================= */

let bpChart = null;
let sugarChart = null;

function slotToIds(slot){
  if(slot === "bb") return { bp:"bb_bp", sugar:"bb_sugar" };
  if(slot === "bl") return { bp:"bl_bp", sugar:"bl_sugar" };
  if(slot === "bd") return { bp:"bd_bp", sugar:"bd_sugar" };
  return { bp:"2h_bp", sugar:"2h_sugar" };
}

async function loadTrends(){
  const slot = document.getElementById("slotSelect") ? document.getElementById("slotSelect").value : "bb";
  const ids = slotToIds(slot);

  const snapshot = await db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .limitToLast(30)
    .get();

  const labels = [];
  const sysData = [];
  const diaData = [];
  const pulseData = [];
  const sugarData = [];

  snapshot.forEach(doc=>{
    const d = doc.data();
    labels.push(doc.id);

    sysData.push(safeNum(d?.[ids.bp]?.sys));
    diaData.push(safeNum(d?.[ids.bp]?.dia));
    pulseData.push(safeNum(d?.[ids.bp]?.pulse));
    sugarData.push(safeNum(d?.[ids.sugar]?.value));
  });

  if(bpChart) bpChart.destroy();
  if(sugarChart) sugarChart.destroy();

  const textCol = chartTextColor();
  const gridCol = chartGridColor();

  bpChart = new Chart(document.getElementById("bpChart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Systolic", data: sysData },
        { label:"Diastolic", data: diaData },
        { label:"Pulse", data: pulseData }
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:textCol}}},
      scales:{
        x:{ticks:{color:textCol},grid:{color:gridCol}},
        y:{ticks:{color:textCol},grid:{color:gridCol}}
      }
    }
  });

  sugarChart = new Chart(document.getElementById("sugarChart"),{
    type:"line",
    data:{ labels, datasets:[ { label:"Sugar", data: sugarData } ] },
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:textCol}}},
      scales:{
        x:{ticks:{color:textCol},grid:{color:gridCol}},
        y:{ticks:{color:textCol},grid:{color:gridCol}}
      }
    }
  });
}

/* ================= EXPORT (RECODED, RELIABLE) ================= */

const BP_SLOTS = [
  { label: "Before Breakfast", id: "bb_bp" },
  { label: "Before Lunch", id: "bl_bp" },
  { label: "Before Dinner", id: "bd_bp" },
  { label: "2 Hours After Dinner", id: "2h_bp" }
];

const SUGAR_SLOTS = [
  { label: "Before Breakfast", id: "bb_sugar" },
  { label: "Before Lunch", id: "bl_sugar" },
  { label: "Before Dinner", id: "bd_sugar" },
  { label: "2 Hours After Dinner", id: "2h_sugar" }
];

function formatISTNow(){
  return new Date().toLocaleString("en-IN", {
    timeZone: "Asia/Kolkata",
    dateStyle: "medium",
    timeStyle: "short"
  });
}

function setExportUI(isWorking, msg){
  const btn = document.getElementById("exportBtn");
  const status = document.getElementById("exportStatus");
  if(btn) btn.disabled = isWorking;
  if(status) status.textContent = msg || "";
}

function getBPString(entry){
  if(!entry) return "";
  const sys = entry.sys || "";
  const dia = entry.dia || "";
  const pulse = entry.pulse || "";
  if(!sys && !dia && !pulse) return "";
  let s = "";
  if(sys && dia) s = `${sys}/${dia}`;
  else if(sys || dia) s = `${sys}${dia ? "/" + dia : ""}`;
  if(pulse) s += (s ? " " : "") + `(Pulse ${pulse})`;
  return s.trim();
}

function getSugarString(entry){
  if(!entry) return "";
  const v = entry.value || "";
  return v ? String(v) : "";
}

async function exportToPDF(){
  try{
    setExportUI(true, "Preparing data…");

    const snap = await db.collection("boards")
      .doc(BOARD_ID)
      .collection("days")
      .orderBy(firebase.firestore.FieldPath.documentId())
      .startAt(EXPORT_START_DATE)
      .endAt(selectedDate)
      .get();

    const days = [];
    snap.forEach(doc => days.push({ date: doc.id, data: doc.data() || {} }));

    if(!days.find(d => d.date === selectedDate)){
      days.push({ date: selectedDate, data: {} });
    }

    days.sort((a,b)=> a.date.localeCompare(b.date));

    setExportUI(true, `Generating PDF (${days.length} day(s))…`);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const pageWidth = doc.internal.pageSize.getWidth();
    const marginX = 40;

    doc.setFontSize(16);
    doc.text("Dharini Checklist Report", marginX, 50);

    doc.setFontSize(10);
    doc.text(`Range: ${EXPORT_START_DATE} to ${selectedDate} (IST)`, marginX, 70);
    doc.text(`Generated: ${formatISTNow()}`, marginX, 85);

    let y = 110;

    for(let i=0; i<days.length; i++){
      const day = days[i];
      const data = day.data || {};

      if(y > 740){
        doc.addPage();
        y = 50;
      }

      doc.setFontSize(14);
      doc.text(day.date, marginX, y);
      y += 10;

      const comments = (data.__comments || "").trim();
      doc.setFontSize(10);
      if(comments){
        const lines = doc.splitTextToSize(`Comments: ${comments}`, pageWidth - marginX*2);
        doc.text(lines, marginX, y + 16);
        y += 16 + lines.length * 12;
      } else {
        doc.text("Comments: —", marginX, y + 16);
        y += 34;
      }

      const bpRows = BP_SLOTS.map(s => {
        const entry = data[s.id] || {};
        return [ s.label, entry.done ? "Done" : "", getBPString(entry) || "—" ];
      });

      doc.autoTable({
        startY: y,
        head: [["BP Slot", "Done", "Reading"]],
        body: bpRows,
        theme: "grid",
        styles: { fontSize: 9, cellPadding: 5 },
        headStyles: { fillColor: [245,245,245], textColor: 20 },
        margin: { left: marginX, right: marginX }
      });

      y = doc.lastAutoTable.finalY + 14;

      const sugarRows = SUGAR_SLOTS.map(s => {
        const entry = data[s.id] || {};
        return [ s.label, entry.done ? "Done" : "", getSugarString(entry) || "—" ];
      });

      doc.autoTable({
        startY: y,
        head: [["Sugar Slot", "Done", "Reading"]],
        body: sugarRows,
        theme: "grid",
        styles: { fontSize: 9, cellPadding: 5 },
        headStyles: { fillColor: [245,245,245], textColor: 20 },
        margin: { left: marginX, right: marginX }
      });

      y = doc.lastAutoTable.finalY + 26;
    }

    const filename = `Dharini_Report_${EXPORT_START_DATE}_to_${selectedDate}.pdf`;
    doc.save(filename);

    setExportUI(false, "Done");
    setTimeout(()=>setExportUI(false,""), 2000);

  } catch(err){
    setExportUI(false, "Export failed. Check internet and try again.");
  }
}

/* ================= BOOT ================= */

document.getElementById("datePicker").onchange = e=>{
  selectedDate = e.target.value;
  loadDay();
};

applyTheme(getSavedTheme());
wireCommentsAutosave();
loadDay();

/* Refresh missed badges every minute (only for current day view) */
setInterval(()=>{
  if(latestDayDataCache) renderAtAGlance(latestDayDataCache);
}, 60*1000);
</script>

</body>
</html>
