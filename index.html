<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dharini Daily Checklist</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<style>
body{font-family:system-ui;background:#f6f7fb;margin:0;padding:16px}
h2{margin-top:0}
.nav{margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
.blockTitle{font-weight:900;margin-bottom:10px}
.task{margin-bottom:12px}
input,textarea{padding:6px;border-radius:6px;border:1px solid #ddd;margin:4px}
button{padding:8px 12px;border-radius:8px;border:0;background:#2f6fed;color:#fff;font-weight:800}
button.ghost{background:#eef0f6;color:#111}
.progress{height:8px;background:#e8eaf2;border-radius:999px;overflow:hidden;margin-bottom:8px}
.progress div{height:100%;background:#2f6fed;width:0%}
.small{font-size:12px;opacity:.75}
hr{border:none;border-top:1px solid #eee;margin:12px 0}
.badge{display:inline-block;background:#111;color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ddd;padding:8px;font-size:12px;vertical-align:top}
th{background:#f5f5f5;text-align:left}
.pdfWrap{background:#fff;padding:16px}
</style>
</head>

<body>

<h2>Dharini Daily Checklist</h2>

<div class="nav">
  <button onclick="shiftDay(-1)">◀ Previous</button>
  <input type="date" id="datePicker">
  <button onclick="shiftDay(1)">Next ▶</button>
</div>

  <a class="btn ghost" href="https://www.icloud.com/shortcuts/e5923e2e7c014ae5b8478bd3cb6326fb" target="_blank" rel="noopener">
  Add Reminders to phone
</a>

<div class="progress"><div id="bar"></div></div>
<div id="percent"></div>

<div id="app"></div>

<div class="card">
  <h3>Comments (for selected day)</h3>
  <textarea id="dayComments" rows="5" style="width:100%"></textarea>
  <div class="small" id="commentsStatus"></div>
</div>

<div class="card">
  <h3>Trends (Last 30 Days)</h3>
  <canvas id="bpChart"></canvas>
  <canvas id="sugarChart"></canvas>
</div>

<div class="card">
  <h3>Export</h3>
  <button onclick="exportSelectedDayPDF()">Export Selected Day</button>
  <button class="ghost" onclick="exportSelectedPlusPreviousPDF()">Export Up To Selected</button>
  <button class="ghost" onclick="exportLastNDaysPDF(30)">Export Last 30 Days</button>
</div>

<div id="pdfContainer" style="position:absolute;left:-99999px;top:-99999px;width:800px"></div>

<script>

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAxjeAx9iMHomGppnnouaJ5ISR3AthNEvU",
  authDomain: "dharini-checklist-sync.firebaseapp.com",
  projectId: "dharini-checklist-sync",
  storageBucket: "dharini-checklist-sync.firebasestorage.app",
  messagingSenderId: "428971704286",
  appId: "1:428971704286:web:bd52c5bb86c9ed3725674f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= SETTINGS ================= */

const BOARD_ID="dharini-global-board";
const TIMEZONE="Asia/Kolkata";
const CEFHUM_END="2026-02-20";
let selectedDate=getISTDate();
let activeDocRef=null;
let unsubscribe=null;
let commentsTimer=null;

/* ================= HELPERS ================= */

function getISTDate(dateObj=null){
  const now=dateObj||new Date();
  const ist=new Date(now.toLocaleString("en-US",{timeZone:TIMEZONE}));
  return ist.toISOString().split("T")[0];
}

function shiftDay(days){
  const d=new Date(selectedDate);
  d.setDate(d.getDate()+days);
  selectedDate=getISTDate(d);
  loadDay();
}

function afterEnd(date){return date>CEFHUM_END;}
function isSunday(date){return new Date(date).getDay()===0;}

function safeNum(x){
  const n=Number(x);
  return Number.isFinite(n)?n:null;
}

/* ================= CHECKLIST ================= */

const blocks=[
{
title:"Before Breakfast",
tasks:[
{id:"bb_bp",text:"Measure BP",type:"bp"},
{id:"bb_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bb_novo10",text:"Novorapid 10u"},
{id:"bb_panD",text:"Pan D"}
]},
{
title:"After Breakfast",
tasks:[
{id:"ab_cefhum",text:"Cefhum",show:(d)=>!afterEnd(d)},
{id:"ab_metxl",text:"Met XL"},
{id:"ab_nikoran",text:"Nikoran"},
{id:"ab_lasilactone",text:"Lasilactone"},
{id:"ab_cobadex",text:"Cobadex"},
{id:"ab_folic",text:"Folic Acid"},
{id:"ab_ivabred",text:"Ivabred"},
{id:"ab_dolo",text:"Dolo (optional)"},
{id:"ab_vitd",text:"Vit D (Sunday only)",show:(d)=>isSunday(d)}
]},
{
title:"Before Lunch",
tasks:[
{id:"bl_bp",text:"Measure BP",type:"bp"},
{id:"bl_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bl_novo12",text:"Novorapid 12u"}
]},
{
title:"After Lunch",
tasks:[
{id:"al_ecosprin",text:"Ecosprin"},
{id:"al_clopitab",text:"Clopitab"}
]},
{
title:"Before Dinner",
tasks:[
{id:"bd_bp",text:"Measure BP",type:"bp"},
{id:"bd_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bd_novo7",text:"Novorapid 7u"}
]},
{
title:"After Dinner Meds",
tasks:[
{id:"ad_cefhum",text:"Cefhum",show:(d)=>!afterEnd(d)},
{id:"ad_halfmet",text:"½ Met XL"},
{id:"ad_nikoran",text:"Nikoran"},
{id:"ad_ivabred",text:"Ivabred"}
]},
{
title:"2 Hours After Dinner",
tasks:[
{id:"2h_bp",text:"Measure BP",type:"bp"},
{id:"2h_sugar",text:"Measure Sugar",type:"sugar"},
{id:"2h_tresiba",text:"Tresiba 16u"},
{id:"2h_dolo",text:"Dolo (if pain)"},
{id:"2h_rosuva",text:"Rosuvastatin"}
]}
];

/* ================= LOAD DAY ================= */

function loadDay(){

  if(unsubscribe)unsubscribe();

  document.getElementById("datePicker").value=selectedDate;

  activeDocRef=db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .doc(selectedDate);

  unsubscribe=activeDocRef.onSnapshot(doc=>{
    const d=doc.data()||{};
    render(d);
    loadComments(d);
  });

  loadTrends();
}

/* ================= RENDER ================= */

function render(data){

  const app=document.getElementById("app");
  app.innerHTML="";
  let total=0,done=0;

  blocks.forEach(block=>{
    const card=document.createElement("div");
    card.className="card";

    const title=document.createElement("div");
    title.className="blockTitle";
    title.textContent=block.title;
    card.appendChild(title);

    block.tasks.forEach(task=>{
      if(task.show && !task.show(selectedDate))return;

      total++;

      const row=document.createElement("div");
      row.className="task";

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked=data?.[task.id]?.done||false;
      if(cb.checked)done++;

      cb.onchange=()=>{
        activeDocRef.set({
          [task.id]:{...data?.[task.id],done:cb.checked}
        },{merge:true});
      };

      row.appendChild(cb);
      row.append(" "+task.text);

      if(task.type==="bp"){
        const sys=document.createElement("input");
        sys.placeholder="Sys";
        sys.value=data?.[task.id]?.sys||"";

        const dia=document.createElement("input");
        dia.placeholder="Dia";
        dia.value=data?.[task.id]?.dia||"";

        const pulse=document.createElement("input");
        pulse.placeholder="Pulse";
        pulse.value=data?.[task.id]?.pulse||"";

        const save=document.createElement("button");
        save.textContent="Save BP";
        save.onclick=()=>{
          activeDocRef.set({
            [task.id]:{
              done:true,
              sys:sys.value,
              dia:dia.value,
              pulse:pulse.value
            }
          },{merge:true});
        };

        row.appendChild(document.createElement("br"));
        row.appendChild(sys);
        row.appendChild(dia);
        row.appendChild(pulse);
        row.appendChild(save);
      }

      if(task.type==="sugar"){
        const val=document.createElement("input");
        val.placeholder="Sugar";
        val.value=data?.[task.id]?.value||"";

        const save=document.createElement("button");
        save.textContent="Save Sugar";
        save.onclick=()=>{
          activeDocRef.set({
            [task.id]:{
              done:true,
              value:val.value
            }
          },{merge:true});
        };

        row.appendChild(document.createElement("br"));
        row.appendChild(val);
        row.appendChild(save);
      }

      card.appendChild(row);
    });

    app.appendChild(card);
  });

  const percent=Math.round((done/total)*100)||0;
  document.getElementById("bar").style.width=percent+"%";
  document.getElementById("percent").textContent=
    percent+"% Complete ("+selectedDate+")";
}

/* ================= COMMENTS ================= */

function loadComments(data){
  const box=document.getElementById("dayComments");
  box.value=data.__comments||"";
}

document.getElementById("dayComments").addEventListener("input",()=>{
  if(commentsTimer)clearTimeout(commentsTimer);
  commentsTimer=setTimeout(()=>{
    activeDocRef.set({
      __comments:document.getElementById("dayComments").value
    },{merge:true});
  },400);
});

/* ================= TRENDS ================= */

let bpChart=null;
let sugarChart=null;

async function loadTrends(){

  const snap=await db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .limitToLast(30)
    .get();

  const labels=[],sys=[],dia=[],pulse=[],sugar=[];

  snap.forEach(doc=>{
    const d=doc.data();
    labels.push(doc.id);
    sys.push(safeNum(d?.bb_bp?.sys));
    dia.push(safeNum(d?.bb_bp?.dia));
    pulse.push(safeNum(d?.bb_bp?.pulse));
    sugar.push(safeNum(d?.bb_sugar?.value));
  });

  if(bpChart)bpChart.destroy();
  if(sugarChart)sugarChart.destroy();

  bpChart=new Chart(document.getElementById("bpChart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Systolic",data:sys},
        {label:"Diastolic",data:dia},
        {label:"Pulse",data:pulse}
      ]
    }
  });

  sugarChart=new Chart(document.getElementById("sugarChart"),{
    type:"line",
    data:{
      labels,
      datasets:[{label:"Sugar",data:sugar}]
    }
  });
}

/* ================= EXPORT ================= */

async function exportSelectedDayPDF(){
  const doc=await activeDocRef.get();
  const days=[{date:selectedDate,data:doc.data()||{}}];
  exportDays(days,"Dharini_"+selectedDate+".pdf");
}

async function exportSelectedPlusPreviousPDF(){
  const snap=await db.collection("boards").doc(BOARD_ID)
    .collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .endAt(selectedDate)
    .get();

  const days=[];
  snap.forEach(doc=>days.push({date:doc.id,data:doc.data()}));
  exportDays(days,"Dharini_Upto_"+selectedDate+".pdf");
}

async function exportLastNDaysPDF(n){
  const snap=await db.collection("boards").doc(BOARD_ID)
    .collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .limitToLast(n)
    .get();

  const days=[];
  snap.forEach(doc=>days.push({date:doc.id,data:doc.data()}));
  exportDays(days,"Dharini_Last_"+n+"_Days.pdf");
}

function exportDays(days,filename){

  const container=document.getElementById("pdfContainer");
  container.innerHTML="";

  const wrap=document.createElement("div");
  wrap.className="pdfWrap";

  wrap.innerHTML=`<h2>Dharini Checklist Report</h2>
  <div>Generated: ${new Date().toLocaleString()}</div><hr/>`;

  days.forEach(day=>{
    wrap.innerHTML+=`<h3>${day.date}</h3>
    <div>Comments: ${day.data?.__comments||""}</div><hr/>`;
  });

  container.appendChild(wrap);

  html2pdf().from(wrap).save(filename);
}

/* ================= BOOT ================= */

document.getElementById("datePicker").onchange=e=>{
  selectedDate=e.target.value;
  loadDay();
};

loadDay();

</script>

</body>
</html>
