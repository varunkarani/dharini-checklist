<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dharini Daily Checklist</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<!-- Reliable PDF generation (data-driven, not screenshot-driven) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

<style>
/* ========= THEME TOKENS ========= */
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:rgba(15,23,42,.75);
  --shadow:0 6px 24px rgba(0,0,0,.06);
  --border:#dddddd;
  --borderSoft:#eeeeee;
  --primary:#2f6fed;
  --btnText:#ffffff;
  --ghostBg:#eef0f6;
  --ghostText:#111111;
  --chipBg:#111111;
  --chipText:#ffffff;
  --progressBg:#e8eaf2;
  --progressFill:#2f6fed;
  --inputBg:#ffffff;
}

html[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f1a2d;
  --text:#e6edf7;
  --muted:rgba(230,237,247,.72);
  --shadow:0 10px 28px rgba(0,0,0,.45);
  --border:rgba(230,237,247,.16);
  --borderSoft:rgba(230,237,247,.10);
  --primary:#4c8dff;
  --btnText:#ffffff;
  --ghostBg:rgba(230,237,247,.10);
  --ghostText:#e6edf7;
  --chipBg:rgba(230,237,247,.14);
  --chipText:#e6edf7;
  --progressBg:rgba(230,237,247,.10);
  --progressFill:#4c8dff;
  --inputBg:rgba(230,237,247,.06);
}

/* ========= BASE ========= */
body{font-family:system-ui;background:var(--bg);color:var(--text);margin:0;padding:16px}
h2{margin:0 0 12px 0}
.nav{margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:var(--shadow);border:1px solid var(--borderSoft)}
.blockTitle{font-weight:900;margin-bottom:10px}
.task{margin-bottom:12px}
input,textarea{
  padding:8px;border-radius:8px;border:1px solid var(--border);
  margin:4px;background:var(--inputBg);color:var(--text)
}
input::placeholder, textarea::placeholder{color:var(--muted)}
button,.btn{
  padding:10px 14px;border-radius:10px;border:0;background:var(--primary);
  color:var(--btnText);font-weight:800;display:inline-block;text-decoration:none
}
button.ghost,.btn.ghost{background:var(--ghostBg);color:var(--ghostText)}
button:disabled{opacity:.55}
.progress{height:8px;background:var(--progressBg);border-radius:999px;overflow:hidden;margin-bottom:8px}
.progress div{height:100%;background:var(--progressFill);width:0%}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid var(--borderSoft);margin:12px 0}
.rowActions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* Theme toggle button */
.themeBtn{
  display:inline-flex;align-items:center;gap:8px;
  padding:10px 14px;border-radius:10px;border:1px solid var(--borderSoft);
  background:var(--ghostBg);color:var(--ghostText);font-weight:800;
}
.themeDot{
  width:10px;height:10px;border-radius:999px;background:var(--progressFill);
}

/* Improve chart canvas in dark mode */
canvas{background:transparent}
</style>
</head>

<body>

<h2>Dharini Daily Checklist</h2>

<div class="nav">
  <button onclick="shiftDay(-1)">◀ Previous</button>
  <input type="date" id="datePicker">
  <button onclick="shiftDay(1)">Next ▶</button>

  <!-- Shortcut install link -->
  <a class="btn ghost" href="https://www.icloud.com/shortcuts/e5923e2e7c014ae5b8478bd3cb6326fb" target="_blank" rel="noopener">
    Add alarm reminders
  </a>

  <!-- Dark mode toggle -->
  <button class="themeBtn" id="themeToggle" type="button" onclick="toggleTheme()">
    <span class="themeDot"></span>
    <span id="themeLabel">Dark mode</span>
  </button>
</div>

<div class="progress"><div id="bar"></div></div>
<div id="percent"></div>

<div id="app"></div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Comments (for selected day)</h3>
  <div class="small">Symptoms, missed dose reason, appetite, sleep, doctor notes.</div>
  <textarea id="dayComments" rows="5" style="width:100%;margin-top:10px"></textarea>
  <div class="small" id="commentsStatus"></div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Trends (Last 30 Days)</h3>
  <canvas id="bpChart"></canvas>
  <div style="height:10px"></div>
  <canvas id="sugarChart"></canvas>
  <div class="small" style="margin-top:8px;">Charts use the Before Breakfast readings as the baseline.</div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Export</h3>
  <div class="small">
    Exports all entries from <b>Feb 14, 2026</b> onwards up to the selected date (inclusive), including all BP/Sugar readings and Comments.
  </div>
  <div class="rowActions" style="margin-top:10px">
    <button id="exportBtn" onclick="exportToPDF()">Export to PDF</button>
    <span class="small" id="exportStatus"></span>
  </div>
</div>

<div class="card" style="text-align:center">
  <div class="small">
    Last Edited:
    <span id="lastEditedValue">—</span>
  </div>
</div>

<script>
/* ================= THEME (DARK MODE) ================= */

function getSavedTheme(){
  return localStorage.getItem("theme") || "system";
}

function getSystemTheme(){
  return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
}

function applyTheme(theme){
  // theme can be: "light" | "dark" | "system"
  const effective = theme === "system" ? getSystemTheme() : theme;
  document.documentElement.setAttribute("data-theme", effective);

  // label
  const label = document.getElementById("themeLabel");
  if(label){
    if(theme === "system"){
      label.textContent = "Theme: System";
    } else if(theme === "dark"){
      label.textContent = "Theme: Dark";
    } else {
      label.textContent = "Theme: Light";
    }
  }

  // refresh charts so labels/ticks remain readable
  refreshChartColors(effective);
}

function toggleTheme(){
  // Cycle: system -> dark -> light -> system
  const current = getSavedTheme();
  const next = current === "system" ? "dark" : (current === "dark" ? "light" : "system");
  localStorage.setItem("theme", next);
  applyTheme(next);
  loadTrends(); // re-render charts with new styles
}

// React to system theme changes if user chose "system"
if(window.matchMedia){
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ()=>{
    if(getSavedTheme() === "system"){
      applyTheme("system");
      loadTrends();
    }
  });
}

/* Chart styling helpers */
function isDarkNow(){
  return document.documentElement.getAttribute("data-theme") === "dark";
}

function chartTextColor(){
  return isDarkNow() ? "rgba(230,237,247,.85)" : "rgba(15,23,42,.85)";
}

function chartGridColor(){
  return isDarkNow() ? "rgba(230,237,247,.12)" : "rgba(15,23,42,.12)";
}

function refreshChartColors(){
  // no-op; kept for clarity
}

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAxjeAx9iMHomGppnnouaJ5ISR3AthNEvU",
  authDomain: "dharini-checklist-sync.firebaseapp.com",
  projectId: "dharini-checklist-sync",
  storageBucket: "dharini-checklist-sync.firebasestorage.app",
  messagingSenderId: "428971704286",
  appId: "1:428971704286:web:bd52c5bb86c9ed3725674f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= SETTINGS ================= */

const BOARD_ID="dharini-global-board";
const TIMEZONE="Asia/Kolkata";
const CEFHUM_END="2026-02-20";
const EXPORT_START_DATE="2026-02-14"; // inclusive

let selectedDate = getISTDate();
let activeDocRef = null;
let unsubscribe = null;
let commentsTimer = null;

/* ================= HELPERS ================= */

function getISTDate(dateObj=null){
  const now = dateObj || new Date();
  const ist = new Date(now.toLocaleString("en-US",{timeZone:TIMEZONE}));
  return ist.toISOString().split("T")[0];
}

function shiftDay(days){
  const d = new Date(selectedDate);
  d.setDate(d.getDate()+days);
  selectedDate = getISTDate(d);
  loadDay();
}

function afterEnd(date){ return date > CEFHUM_END; }
function isSunday(date){ return new Date(date).getDay() === 0; }

function safeNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

function updateLastEdited(){
  if(!activeDocRef) return;
  activeDocRef.set({
    __lastEdited: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
}

function renderLastEdited(data){
  const el = document.getElementById("lastEditedValue");
  if(!el) return;

  if(!data.__lastEdited){
    el.textContent = "No edits yet";
    return;
  }

  const ts = data.__lastEdited.toDate();
  el.textContent = ts.toLocaleString("en-IN", {
    timeZone: "Asia/Kolkata",
    dateStyle: "medium",
    timeStyle: "short"
  });
}

/* ================= CHECKLIST ================= */

const blocks = [
{
  title:"Before Breakfast",
  tasks:[
    { id:"bb_bp", text:"Measure BP", type:"bp"},
    { id:"bb_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bb_novo10", text:"Novorapid 10u"},
    { id:"bb_panD", text:"Pan D"}
  ]
},
{
  title:"After Breakfast",
  tasks:[
    { id:"ab_cefhum", text:"Cefhum", show:(d)=>!afterEnd(d)},
    { id:"ab_metxl", text:"Met XL"},
    { id:"ab_nikoran", text:"Nikoran"},
    { id:"ab_lasilactone", text:"Lasilactone"},
    { id:"ab_cobadex", text:"Cobadex"},
    { id:"ab_folic", text:"Folic Acid"},
    { id:"ab_ivabred", text:"Ivabred"},
    { id:"ab_dolo", text:"Dolo (optional)"},
    { id:"ab_vitd", text:"Vit D (Sunday only)", show:(d)=>isSunday(d)}
  ]
},
{
  title:"Before Lunch",
  tasks:[
    { id:"bl_bp", text:"Measure BP", type:"bp"},
    { id:"bl_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bl_novo12", text:"Novorapid 12u"}
  ]
},
{
  title:"After Lunch",
  tasks:[
    { id:"al_ecosprin", text:"Ecosprin"},
    { id:"al_clopitab", text:"Clopitab"}
  ]
},
{
  title:"Before Dinner",
  tasks:[
    { id:"bd_bp", text:"Measure BP", type:"bp"},
    { id:"bd_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bd_novo7", text:"Novorapid 7u"}
  ]
},
{
  title:"After Dinner",
  tasks:[
    { id:"ad_cefhum", text:"Cefhum", show:(d)=>!afterEnd(d)},
    { id:"ad_halfmet", text:"½ Met XL"},
    { id:"ad_nikoran", text:"Nikoran"},
    { id:"ad_ivabred", text:"Ivabred"}
  ]
},
{
  title:"2 Hours After Dinner",
  tasks:[
    { id:"2h_bp", text:"Measure BP", type:"bp"},
    { id:"2h_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"2h_tresiba", text:"Tresiba 16u"},
    { id:"2h_dolo", text:"Dolo (if pain)"},
    { id:"2h_rosuva", text:"Rosuvastatin"}
  ]
}
];

function visibleTasksForDate(block, date){
  return block.tasks.filter(t => !t.show || t.show(date));
}

/* ================= LOAD DAY ================= */

function loadDay(){
  if(unsubscribe) unsubscribe();

  document.getElementById("datePicker").value = selectedDate;

  activeDocRef = db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .doc(selectedDate);

  unsubscribe = activeDocRef.onSnapshot(doc=>{
    const d = doc.data() || {};
    render(d);
    loadCommentsIntoBox(d);
    renderLastEdited(d);
  });

  loadTrends();
}

/* ================= RENDER UI ================= */

function render(data){
  const app = document.getElementById("app");
  app.innerHTML = "";

  let total = 0, done = 0;

  blocks.forEach(block=>{
    const card = document.createElement("div");
    card.className = "card";

    const title = document.createElement("div");
    title.className = "blockTitle";
    title.textContent = block.title;
    card.appendChild(title);

    visibleTasksForDate(block, selectedDate).forEach(task=>{
      total++;

      const row = document.createElement("div");
      row.className = "task";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = data?.[task.id]?.done || false;
      if(cb.checked) done++;

      cb.onchange = ()=>{
        activeDocRef.set({
          [task.id]: { ...data?.[task.id], done: cb.checked }
        }, { merge:true });
        updateLastEdited();
      };

      row.appendChild(cb);
      row.append(" " + task.text);

      if(task.type === "bp"){
        const sys = document.createElement("input");
        sys.placeholder = "Sys";
        sys.value = data?.[task.id]?.sys || "";
        sys.inputMode = "numeric";

        const dia = document.createElement("input");
        dia.placeholder = "Dia";
        dia.value = data?.[task.id]?.dia || "";
        dia.inputMode = "numeric";

        const pulse = document.createElement("input");
        pulse.placeholder = "Pulse";
        pulse.value = data?.[task.id]?.pulse || "";
        pulse.inputMode = "numeric";

        const save = document.createElement("button");
        save.textContent = "Save BP";
        save.onclick = ()=>{
          activeDocRef.set({
            [task.id]: {
              done: true,
              sys: sys.value,
              dia: dia.value,
              pulse: pulse.value
            }
          }, { merge:true });
          updateLastEdited();
        };

        row.appendChild(document.createElement("br"));
        row.appendChild(sys);
        row.appendChild(dia);
        row.appendChild(pulse);
        row.appendChild(save);
      }

      if(task.type === "sugar"){
        const val = document.createElement("input");
        val.placeholder = "Sugar";
        val.value = data?.[task.id]?.value || "";
        val.inputMode = "decimal";

        const save = document.createElement("button");
        save.textContent = "Save Sugar";
        save.onclick = ()=>{
          activeDocRef.set({
            [task.id]: {
              done: true,
              value: val.value
            }
          }, { merge:true });
          updateLastEdited();
        };

        row.appendChild(document.createElement("br"));
        row.appendChild(val);
        row.appendChild(save);
      }

      card.appendChild(row);
    });

    app.appendChild(card);
  });

  const percent = total ? Math.round((done/total)*100) : 0;
  document.getElementById("bar").style.width = percent + "%";
  document.getElementById("percent").textContent = percent + "% Complete (" + selectedDate + ")";
}

/* ================= COMMENTS ================= */

function loadCommentsIntoBox(dayData){
  const box = document.getElementById("dayComments");
  if(!box) return;

  const incoming = dayData.__comments || "";
  if(document.activeElement !== box && box.value !== incoming){
    box.value = incoming;
  }

  const status = document.getElementById("commentsStatus");
  if(status) status.textContent = "";
}

function wireCommentsAutosave(){
  const box = document.getElementById("dayComments");
  if(!box) return;

  box.addEventListener("input", ()=>{
    const status = document.getElementById("commentsStatus");
    if(status) status.textContent = "Saving…";

    if(commentsTimer) clearTimeout(commentsTimer);

    commentsTimer = setTimeout(async ()=>{
      try{
        if(!activeDocRef) return;
        await activeDocRef.set({
          __comments: box.value,
          __lastEdited: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        if(status) status.textContent = "Saved";
      } catch(e){
        if(status) status.textContent = "Save failed (check internet)";
      }
    }, 400);
  });
}

/* ================= TRENDS ================= */

let bpChart = null;
let sugarChart = null;

async function loadTrends(){
  const snapshot = await db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .limitToLast(30)
    .get();

  const labels = [];
  const sysData = [];
  const diaData = [];
  const pulseData = [];
  const sugarData = [];

  snapshot.forEach(doc=>{
    const d = doc.data();
    labels.push(doc.id);
    sysData.push(safeNum(d?.bb_bp?.sys));
    diaData.push(safeNum(d?.bb_bp?.dia));
    pulseData.push(safeNum(d?.bb_bp?.pulse));
    sugarData.push(safeNum(d?.bb_sugar?.value));
  });

  if(bpChart) bpChart.destroy();
  if(sugarChart) sugarChart.destroy();

  const textCol = chartTextColor();
  const gridCol = chartGridColor();

  bpChart = new Chart(document.getElementById("bpChart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Systolic", data: sysData },
        { label:"Diastolic", data: diaData },
        { label:"Pulse", data: pulseData }
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:textCol}}},
      scales:{
        x:{ticks:{color:textCol},grid:{color:gridCol}},
        y:{ticks:{color:textCol},grid:{color:gridCol}}
      }
    }
  });

  sugarChart = new Chart(document.getElementById("sugarChart"),{
    type:"line",
    data:{ labels, datasets:[ { label:"Sugar", data: sugarData } ] },
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:textCol}}},
      scales:{
        x:{ticks:{color:textCol},grid:{color:gridCol}},
        y:{ticks:{color:textCol},grid:{color:gridCol}}
      }
    }
  });
}

/* ================= EXPORT (RECODED, RELIABLE) ================= */

const BP_SLOTS = [
  { label: "Before Breakfast", id: "bb_bp" },
  { label: "Before Lunch", id: "bl_bp" },
  { label: "Before Dinner", id: "bd_bp" },
  { label: "2 Hours After Dinner", id: "2h_bp" }
];

const SUGAR_SLOTS = [
  { label: "Before Breakfast", id: "bb_sugar" },
  { label: "Before Lunch", id: "bl_sugar" },
  { label: "Before Dinner", id: "bd_sugar" },
  { label: "2 Hours After Dinner", id: "2h_sugar" }
];

function formatISTNow(){
  return new Date().toLocaleString("en-IN", {
    timeZone: "Asia/Kolkata",
    dateStyle: "medium",
    timeStyle: "short"
  });
}

function setExportUI(isWorking, msg){
  const btn = document.getElementById("exportBtn");
  const status = document.getElementById("exportStatus");
  if(btn) btn.disabled = isWorking;
  if(status) status.textContent = msg || "";
}

function getBPString(entry){
  if(!entry) return "";
  const sys = entry.sys || "";
  const dia = entry.dia || "";
  const pulse = entry.pulse || "";
  if(!sys && !dia && !pulse) return "";
  let s = "";
  if(sys && dia) s = `${sys}/${dia}`;
  else if(sys || dia) s = `${sys}${dia ? "/" + dia : ""}`;
  if(pulse) s += (s ? " " : "") + `(Pulse ${pulse})`;
  return s.trim();
}

function getSugarString(entry){
  if(!entry) return "";
  const v = entry.value || "";
  return v ? String(v) : "";
}

async function exportToPDF(){
  try{
    setExportUI(true, "Preparing data…");

    const snap = await db.collection("boards")
      .doc(BOARD_ID)
      .collection("days")
      .orderBy(firebase.firestore.FieldPath.documentId())
      .startAt(EXPORT_START_DATE)
      .endAt(selectedDate)
      .get();

    const days = [];
    snap.forEach(doc => days.push({ date: doc.id, data: doc.data() || {} }));

    if(!days.find(d => d.date === selectedDate)){
      days.push({ date: selectedDate, data: {} });
    }

    days.sort((a,b)=> a.date.localeCompare(b.date));

    setExportUI(true, `Generating PDF (${days.length} day(s))…`);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const pageWidth = doc.internal.pageSize.getWidth();
    const marginX = 40;

    doc.setFontSize(16);
    doc.text("Dharini Checklist Report", marginX, 50);

    doc.setFontSize(10);
    doc.text(`Range: ${EXPORT_START_DATE} to ${selectedDate} (IST)`, marginX, 70);
    doc.text(`Generated: ${formatISTNow()}`, marginX, 85);

    let y = 110;

    for(let i=0; i<days.length; i++){
      const day = days[i];
      const data = day.data || {};

      if(y > 740){
        doc.addPage();
        y = 50;
      }

      doc.setFontSize(14);
      doc.text(day.date, marginX, y);
      y += 10;

      const comments = (data.__comments || "").trim();
      doc.setFontSize(10);
      if(comments){
        const lines = doc.splitTextToSize(`Comments: ${comments}`, pageWidth - marginX*2);
        doc.text(lines, marginX, y + 16);
        y += 16 + lines.length * 12;
      } else {
        doc.text("Comments: —", marginX, y + 16);
        y += 34;
      }

      const bpRows = BP_SLOTS.map(s => {
        const entry = data[s.id] || {};
        return [ s.label, entry.done ? "Done" : "", getBPString(entry) || "—" ];
      });

      doc.autoTable({
        startY: y,
        head: [["BP Slot", "Done", "Reading"]],
        body: bpRows,
        theme: "grid",
        styles: { fontSize: 9, cellPadding: 5 },
        headStyles: { fillColor: [245,245,245], textColor: 20 },
        margin: { left: marginX, right: marginX }
      });

      y = doc.lastAutoTable.finalY + 14;

      const sugarRows = SUGAR_SLOTS.map(s => {
        const entry = data[s.id] || {};
        return [ s.label, entry.done ? "Done" : "", getSugarString(entry) || "—" ];
      });

      doc.autoTable({
        startY: y,
        head: [["Sugar Slot", "Done", "Reading"]],
        body: sugarRows,
        theme: "grid",
        styles: { fontSize: 9, cellPadding: 5 },
        headStyles: { fillColor: [245,245,245], textColor: 20 },
        margin: { left: marginX, right: marginX }
      });

      y = doc.lastAutoTable.finalY + 26;
    }

    const filename = `Dharini_Report_${EXPORT_START_DATE}_to_${selectedDate}.pdf`;
    doc.save(filename);

    setExportUI(false, "Done");
    setTimeout(()=>setExportUI(false,""), 2000);

  } catch(err){
    setExportUI(false, "Export failed. Check internet and try again.");
  }
}

/* ================= BOOT ================= */

document.getElementById("datePicker").onchange = e=>{
  selectedDate = e.target.value;
  loadDay();
};

// Apply saved theme on load
applyTheme(getSavedTheme());

// Ensure button label is correct immediately
applyTheme(getSavedTheme());

wireCommentsAutosave();
loadDay();
</script>

</body>
</html>
