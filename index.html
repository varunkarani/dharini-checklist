<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dharini's Daily Checklist</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<!-- Reliable PDF generation (data-driven, not screenshot-driven) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:rgba(15,23,42,.75);
  --shadow:0 6px 24px rgba(0,0,0,.06);
  --border:#dddddd;
  --borderSoft:#eeeeee;
  --primary:#2f6fed;
  --btnText:#ffffff;
  --ghostBg:#eef0f6;
  --ghostText:#111111;
  --progressBg:#e8eaf2;
  --progressFill:#2f6fed;
  --inputBg:#ffffff;
  --danger:#d62c2c;
  --warn:#b45309;
  --ok:#0f9d58;
}

html[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f1a2d;
  --text:#e6edf7;
  --muted:rgba(230,237,247,.72);
  --shadow:0 10px 28px rgba(0,0,0,.45);
  --border:rgba(230,237,247,.16);
  --borderSoft:rgba(230,237,247,.10);
  --primary:#4c8dff;
  --btnText:#ffffff;
  --ghostBg:rgba(230,237,247,.10);
  --ghostText:#e6edf7;
  --progressBg:rgba(230,237,247,.10);
  --progressFill:#4c8dff;
  --inputBg:rgba(230,237,247,.06);
  --danger:#ff6b6b;
  --warn:#ffb020;
  --ok:#44d07f;
}

/* Prevent 100% width inputs from overflowing cards (iOS especially) */
*{ box-sizing:border-box; }

body{font-family:system-ui;background:var(--bg);color:var(--text);margin:0;padding:16px}
h2{margin:0 0 12px 0}
.nav{margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:var(--shadow);border:1px solid var(--borderSoft)}
.blockTitle{font-weight:900;margin-bottom:10px}
.task{margin-bottom:12px}

input,textarea,select{
  padding:10px;border-radius:10px;border:1px solid var(--border);
  margin:4px;background:var(--inputBg);color:var(--text);font-size:16px
}
input::placeholder, textarea::placeholder{color:var(--muted)}

#dayComments{
  width:100%;
  display:block;
}

button,.btn{
  padding:10px 14px;border-radius:10px;border:0;background:var(--primary);
  color:var(--btnText);font-weight:800;display:inline-block;text-decoration:none
}
button.ghost,.btn.ghost{background:var(--ghostBg);color:var(--ghostText)}
button:disabled{opacity:.55}

.progress{
  height:8px;
  background:var(--progressBg);
  border-radius:999px;
  overflow:hidden;
  margin:12px 0 6px 0;
}
.progress div{height:100%;background:var(--progressFill);width:0%}

.small{font-size:12px;color:var(--muted)}
.rowActions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

#percent{
  margin-bottom:14px;
  font-weight:600;
}

.themeBtn{
  display:inline-flex;align-items:center;gap:8px;
  padding:10px 14px;border-radius:10px;border:1px solid var(--borderSoft);
  background:var(--ghostBg);color:var(--ghostText);font-weight:800;
}
.themeDot{width:10px;height:10px;border-radius:999px;background:var(--progressFill)}

/* Big keypad inputs */
.bigInputs{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
.bigInputs input{width:110px;font-size:20px;padding:12px 12px}
.bigInputs input.narrow{width:95px}

/* Abnormal highlight */
.readingTag{
  display:inline-block;
  padding:4px 8px;border-radius:999px;
  border:1px solid var(--borderSoft);
  font-size:12px;font-weight:900;
  margin-left:8px;
}
.readingTag.danger{border-color:rgba(214,44,44,.35);color:var(--danger)}
.readingTag.warn{border-color:rgba(180,83,9,.35);color:var(--warn)}
.readingTag.ok{border-color:rgba(15,157,88,.35);color:var(--ok)}

/* Chart sizing (critical for iPhone Safari) */
.chartWrap{
  width:100%;
  height:260px;
}
.chartWrap canvas{
  width:100% !important;
  height:100% !important;
  display:block;
}
</style>
</head>

<body>

<h2>Dharini's Daily Checklist</h2>

<div class="nav">
  <button onclick="shiftDay(-1)">◀ Previous</button>
  <input type="date" id="datePicker">
  <button onclick="shiftDay(1)">Next ▶</button>

  <a class="btn ghost" href="https://www.icloud.com/shortcuts/e5923e2e7c014ae5b8478bd3cb6326fb" target="_blank" rel="noopener">
    Add alarms
  </a>

  <button class="themeBtn" id="themeToggle" type="button" onclick="toggleTheme()">
    <span class="themeDot"></span>
    <span id="themeLabel">Theme</span>
  </button>
</div>

<div class="progress"><div id="bar"></div></div>
<div id="percent"></div>

<div id="app"></div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Comments (for selected day)</h3>
  <div class="small">Symptoms, missed dose, sleep, appetite or meal notes.</div>
  <textarea id="dayComments" rows="5"></textarea>
  <div class="small" id="commentsStatus"></div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0;">Trends</h3>
  <div class="rowActions" style="margin-bottom:10px">
    <span class="small" style="font-weight:900">Chart slot:</span>
    <select id="slotSelect" onchange="loadTrends()">
      <option value="bb">Before Breakfast</option>
      <option value="bl">Before Lunch</option>
      <option value="bd">Before Dinner</option>
      <option value="2h">2 Hours After Dinner</option>
    </select>
    <span class="small">Shows the selected slot across the last 30 days.</span>
  </div>

  <div id="trendsStatus" class="small" style="margin:6px 0 10px 0;"></div>

  <div class="chartWrap">
    <canvas id="bpChart"></canvas>
  </div>

  <div style="height:12px"></div>

  <div class="chartWrap">
    <canvas id="sugarChart"></canvas>
  </div>
</div> <!-- CLOSE Trends card -->

<div class="card">
  <h3 style="margin:0 0 8px 0;">Export</h3>
  <div class="small">
    Exports all entries from <b>Feb 14</b> up to the selected date.
  </div>
  <div class="rowActions" style="margin-top:10px">
    <button id="exportBtn" onclick="exportToPDF()">Export to PDF</button>
    <span class="small" id="exportStatus"></span>
  </div>
</div>

<div class="card" style="text-align:center">
  <div class="small">
    Last Edited:
    <span id="lastEditedValue">—</span>
  </div>
</div>

<script>
/* ================= THEME (DARK MODE) ================= */

function getSavedTheme(){ return localStorage.getItem("theme") || "system"; }

function getSystemTheme(){
  return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
}

function applyTheme(theme){
  const effective = theme === "system" ? getSystemTheme() : theme;
  document.documentElement.setAttribute("data-theme", effective);

  const label = document.getElementById("themeLabel");
  if(label){
    if(theme === "system") label.textContent = "Theme: System";
    if(theme === "dark") label.textContent = "Theme: Dark";
    if(theme === "light") label.textContent = "Theme: Light";
  }
}

function toggleTheme(){
  const current = getSavedTheme();
  const next = current === "system" ? "dark" : (current === "dark" ? "light" : "system");
  localStorage.setItem("theme", next);
  applyTheme(next);
  loadTrends();
}

if(window.matchMedia){
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ()=>{
    if(getSavedTheme() === "system"){
      applyTheme("system");
      loadTrends();
    }
  });
}

function isDarkNow(){ return document.documentElement.getAttribute("data-theme") === "dark"; }
function chartTextColor(){ return isDarkNow() ? "rgba(230,237,247,.85)" : "rgba(15,23,42,.85)"; }
function chartGridColor(){ return isDarkNow() ? "rgba(230,237,247,.12)" : "rgba(15,23,42,.12)"; }

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAxjeAx9iMHomGppnnouaJ5ISR3AthNEvU",
  authDomain: "dharini-checklist-sync.firebaseapp.com",
  projectId: "dharini-checklist-sync",
  storageBucket: "dharini-checklist-sync.firebasestorage.app",
  messagingSenderId: "428971704286",
  appId: "1:428971704286:web:bd52c5bb86c9ed3725674f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= SETTINGS ================= */

const BOARD_ID="dharini-global-board";
const TIMEZONE="Asia/Kolkata";
const CEFHUM_END="2026-02-20";
const EXPORT_START_DATE="2026-02-14"; // inclusive

let selectedDate = getISTDate();
let activeDocRef = null;
let unsubscribe = null;
let commentsTimer = null;

/* ================= HELPERS ================= */

function getISTDate(dateObj=null){
  const now = dateObj || new Date();
  const ist = new Date(now.toLocaleString("en-US",{timeZone:TIMEZONE}));
  return ist.toISOString().split("T")[0];
}

function shiftDay(days){
  const d = new Date(selectedDate);
  d.setDate(d.getDate()+days);
  selectedDate = getISTDate(d);
  loadDay();
}

function afterEnd(date){ return date > CEFHUM_END; }
function isSunday(date){ return new Date(date).getDay() === 0; }

function safeNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

function updateLastEdited(){
  if(!activeDocRef) return;
  activeDocRef.set({
    __lastEdited: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
}

function renderLastEdited(data){
  const el = document.getElementById("lastEditedValue");
  if(!el) return;

  if(!data.__lastEdited){
    el.textContent = "No edits yet";
    return;
  }

  const ts = data.__lastEdited.toDate();
  el.textContent = ts.toLocaleString("en-IN", {
    timeZone: "Asia/Kolkata",
    dateStyle: "medium",
    timeStyle: "short"
  });
}

/* Target ranges + flags */
const TARGETS = {
  bp_sys_high: 140,
  bp_dia_high: 90,
  sugar_low: 70,
  sugar_high: 180
};

function bpStatus(entry){
  const sys = safeNum(entry?.sys);
  const dia = safeNum(entry?.dia);
  if(sys === null && dia === null) return "none";
  if((sys !== null && sys >= TARGETS.bp_sys_high) || (dia !== null && dia >= TARGETS.bp_dia_high)) return "danger";
  return "ok";
}
function sugarStatus(entry){
  const v = safeNum(entry?.value);
  if(v === null) return "none";
  if(v < TARGETS.sugar_low) return "warn";
  if(v > TARGETS.sugar_high) return "danger";
  return "ok";
}

/* ================= CHECKLIST ================= */

const blocks = [
{
  title:"Before Breakfast",
  key:"bb",
  tasks:[
    { id:"bb_bp", text:"Measure BP", type:"bp"},
    { id:"bb_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bb_novo10", text:"Novorapid 10u"},
    { id:"bb_panD", text:"Pan D"}
  ]
},
{
  title:"After Breakfast",
  key:"ab",
  tasks:[
    { id:"ab_ceftum", text:"Ceftum", show:(d)=>!afterEnd(d)},
    { id:"ab_metxl", text:"Met XL"},
    { id:"ab_nikoran", text:"Nikoran"},
    { id:"ab_lasilactone", text:"Lasilactone"},
    { id:"ab_cobadex", text:"Cobadex"},
    { id:"ab_folic", text:"Folic Acid"},
    { id:"ab_ivabred", text:"Ivabred"},
    { id:"ab_dolo", text:"Dolo (optional)"},
    { id:"ab_vitd", text:"Vit D (Sunday only)", show:(d)=>isSunday(d)}
  ]
},
{
  title:"Before Lunch",
  key:"bl",
  tasks:[
    { id:"bl_bp", text:"Measure BP", type:"bp"},
    { id:"bl_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bl_novo12", text:"Novorapid 12u"}
  ]
},
{
  title:"After Lunch",
  key:"al",
  tasks:[
    { id:"al_ecosprin", text:"Ecosprin"},
    { id:"al_clopitab", text:"Clopitab"}
  ]
},
{
  title:"Before Dinner",
  key:"bd",
  tasks:[
    { id:"bd_bp", text:"Measure BP", type:"bp"},
    { id:"bd_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"bd_novo7", text:"Novorapid 7u"}
  ]
},
{
  title:"After Dinner",
  key:"ad",
  tasks:[
    { id:"ad_ceftum", text:"Ceftum", show:(d)=>!afterEnd(d)},
    { id:"ad_halfmet", text:"½ Met XL"},
    { id:"ad_nikoran", text:"Nikoran"},
    { id:"ad_ivabred", text:"Ivabred"}
  ]
},
{
  title:"2 Hours After Dinner",
  key:"2h",
  tasks:[
    { id:"2h_bp", text:"Measure BP", type:"bp"},
    { id:"2h_sugar", text:"Measure Sugar", type:"sugar"},
    { id:"2h_tresiba", text:"Tresiba 16u"},
    { id:"2h_rosuva", text:"Rosuvastatin"},
    { id:"2h_dolo", text:"Dolo (optional)"}
  ]
}
];

function visibleTasksForDate(block, date){
  return block.tasks.filter(t => !t.show || t.show(date));
}

function calcCompletionForDate(data, date){
  let total = 0, done = 0;
  blocks.forEach(b=>{
    visibleTasksForDate(b, date).forEach(t=>{
      total++;
      if(data?.[t.id]?.done) done++;
    });
  });
  const percent = total ? Math.round((done/total)*100) : 0;
  return { total, done, percent };
}

/* ================= LOAD DAY ================= */

function loadDay(){
  if(unsubscribe) unsubscribe();

  document.getElementById("datePicker").value = selectedDate;

  activeDocRef = db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .doc(selectedDate);

  unsubscribe = activeDocRef.onSnapshot(doc=>{
    const d = doc.data() || {};
    render(d);
    loadCommentsIntoBox(d);
    renderLastEdited(d);
  });

  loadTrends();
}

/* ================= RENDER UI ================= */

function render(data){
  const app = document.getElementById("app");
  app.innerHTML = "";

  let total = 0, done = 0;

  blocks.forEach(block=>{
    const card = document.createElement("div");
    card.className = "card";

    const title = document.createElement("div");
    title.className = "blockTitle";
    title.textContent = block.title;
    card.appendChild(title);

    visibleTasksForDate(block, selectedDate).forEach(task=>{
      total++;

      const row = document.createElement("div");
      row.className = "task";
      row.id = "task_" + task.id;

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = data?.[task.id]?.done || false;
      if(cb.checked) done++;

      cb.onchange = ()=>{
        activeDocRef.set({
          [task.id]: { ...data?.[task.id], done: cb.checked }
        }, { merge:true });
        updateLastEdited();
      };

      row.appendChild(cb);
      row.append(" " + task.text);

      if(task.type === "bp"){
        const st = bpStatus(data?.[task.id]);
        if(st !== "none"){
          const tag = document.createElement("span");
          tag.className = "readingTag " + st;
          tag.textContent = st === "danger" ? "High" : "OK";
          row.appendChild(tag);
        }
      }
      if(task.type === "sugar"){
        const st = sugarStatus(data?.[task.id]);
        if(st !== "none"){
          const tag = document.createElement("span");
          tag.className = "readingTag " + st;
          tag.textContent = st === "danger" ? "High" : (st === "warn" ? "Low" : "OK");
          row.appendChild(tag);
        }
      }

      if(task.type === "bp"){
        const sys = document.createElement("input");
        sys.placeholder = "Sys";
        sys.value = data?.[task.id]?.sys || "";
        sys.inputMode = "numeric";
        sys.type = "number";
        sys.className = "narrow";

        const dia = document.createElement("input");
        dia.placeholder = "Dia";
        dia.value = data?.[task.id]?.dia || "";
        dia.inputMode = "numeric";
        dia.type = "number";
        dia.className = "narrow";

        const pulse = document.createElement("input");
        pulse.placeholder = "Pulse";
        pulse.value = data?.[task.id]?.pulse || "";
        pulse.inputMode = "numeric";
        pulse.type = "number";
        pulse.className = "narrow";

        const save = document.createElement("button");
        save.textContent = "Save";
        save.onclick = ()=>{
          activeDocRef.set({
            [task.id]: {
              done: true,
              sys: sys.value,
              dia: dia.value,
              pulse: pulse.value
            }
          }, { merge:true });
          updateLastEdited();
        };

        const wrap = document.createElement("div");
        wrap.className = "bigInputs";
        wrap.appendChild(sys);
        wrap.appendChild(dia);
        wrap.appendChild(pulse);
        wrap.appendChild(save);

        row.appendChild(document.createElement("br"));
        row.appendChild(wrap);
      }

      if(task.type === "sugar"){
        const val = document.createElement("input");
        val.placeholder = "Sugar";
        val.value = data?.[task.id]?.value || "";
        val.inputMode = "numeric";
        val.type = "number";
        val.style.width = "140px";
        val.style.fontSize = "20px";
        val.style.padding = "12px 12px";

        const save = document.createElement("button");
        save.textContent = "Save";
        save.onclick = ()=>{
          activeDocRef.set({
            [task.id]: {
              done: true,
              value: val.value
            }
          }, { merge:true });
          updateLastEdited();
        };

        const wrap = document.createElement("div");
        wrap.className = "bigInputs";
        wrap.appendChild(val);
        wrap.appendChild(save);

        row.appendChild(document.createElement("br"));
        row.appendChild(wrap);
      }

      card.appendChild(row);
    });

    app.appendChild(card);
  });

  const percent = total ? Math.round((done/total)*100) : 0;
  document.getElementById("bar").style.width = percent + "%";
  document.getElementById("percent").textContent = percent + "% Complete";
}

/* ================= COMMENTS ================= */

function loadCommentsIntoBox(dayData){
  const box = document.getElementById("dayComments");
  if(!box) return;

  const incoming = dayData.__comments || "";
  if(document.activeElement !== box && box.value !== incoming){
    box.value = incoming;
  }

  const status = document.getElementById("commentsStatus");
  if(status) status.textContent = "";
}

function wireCommentsAutosave(){
  const box = document.getElementById("dayComments");
  if(!box) return;

  box.addEventListener("input", ()=>{
    const status = document.getElementById("commentsStatus");
    if(status) status.textContent = "Saving…";

    if(commentsTimer) clearTimeout(commentsTimer);

    commentsTimer = setTimeout(async ()=>{
      try{
        if(!activeDocRef) return;
        await activeDocRef.set({
          __comments: box.value,
          __lastEdited: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        if(status) status.textContent = "Saved";
      } catch(e){
        if(status) status.textContent = "Save failed (check internet)";
      }
    }, 400);
  });
}
/* ================= TRENDS ================= */

let bpChart = null;
let sugarChart = null;

function slotToIds(slot){
  if(slot === "bb") return { bp:"bb_bp", sugar:"bb_sugar" };
  if(slot === "bl") return { bp:"bl_bp", sugar:"bl_sugar" };
  if(slot === "bd") return { bp:"bd_bp", sugar:"bd_sugar" };
  return { bp:"2h_bp", sugar:"2h_sugar" };
}

// Build last N dates ending at selectedDate, as YYYY-MM-DD strings
function lastNDates(endDateStr, n){
  const MIN_DATE = "2026-02-14"; // chart must not go before this
  const out = [];

  const end = new Date(endDateStr + "T00:00:00");
  const min = new Date(MIN_DATE + "T00:00:00");

  for(let i = n - 1; i >= 0; i--){
    const d = new Date(end);
    d.setDate(end.getDate() - i);

    if(d < min) continue; // skip anything before Feb 14

    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");

    out.push(`${yyyy}-${mm}-${dd}`);
  }

  return out;
}

async function loadTrends(){
  const statusEl = document.getElementById("trendsStatus");
  const setStatus = (msg) => { if(statusEl) statusEl.textContent = msg || ""; };

  try{
    setStatus("");

    if(typeof Chart === "undefined"){
      setStatus("Trends error: Chart.js did not load.");
      return;
    }

    const slot = document.getElementById("slotSelect") ? document.getElementById("slotSelect").value : "bb";
    const ids = slotToIds(slot);

    // Index-free approach: read last 30 days by doc id
    const dates = lastNDates(selectedDate, 30);

    const reads = dates.map(dateStr =>
      db.collection("boards")
        .doc(BOARD_ID)
        .collection("days")
        .doc(dateStr)
        .get()
        .then(snap => ({ id: dateStr, data: snap.exists ? (snap.data() || {}) : null }))
    );

    const results = await Promise.all(reads);

    const labels = [];
    const sysData = [];
    const diaData = [];
    const pulseData = [];
    const sugarData = [];

    results.forEach(r=>{
      labels.push(r.id);

      const d = r.data || {};
      sysData.push(safeNum(d?.[ids.bp]?.sys));
      diaData.push(safeNum(d?.[ids.bp]?.dia));
      pulseData.push(safeNum(d?.[ids.bp]?.pulse));
      sugarData.push(safeNum(d?.[ids.sugar]?.value));
    });

    const hasAny =
      sysData.some(v=>v!==null) ||
      diaData.some(v=>v!==null) ||
      pulseData.some(v=>v!==null) ||
      sugarData.some(v=>v!==null);

    if(!hasAny){
      setStatus("No trend data found in the last 30 days for this slot.");
    }

    if(bpChart){ bpChart.destroy(); bpChart = null; }
    if(sugarChart){ sugarChart.destroy(); sugarChart = null; }

    const textCol = chartTextColor();
    const gridCol = chartGridColor();

    const bpCanvas = document.getElementById("bpChart");
    const sugarCanvas = document.getElementById("sugarChart");

    if(!bpCanvas || !sugarCanvas){
      setStatus("Trends error: chart canvas missing in HTML.");
      return;
    }

    bpChart = new Chart(bpCanvas.getContext("2d"),{
      type:"line",
      data:{
        labels,
        datasets:[
          { label:"Systolic", data: sysData },
          { label:"Diastolic", data: diaData },
          { label:"Pulse", data: pulseData }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        plugins:{ legend:{ labels:{ color:textCol } } },
        scales:{
          x:{ ticks:{ color:textCol }, grid:{ color:gridCol } },
          y:{ ticks:{ color:textCol }, grid:{ color:gridCol } }
        }
      }
    });

    sugarChart = new Chart(sugarCanvas.getContext("2d"),{
      type:"line",
      data:{
        labels,
        datasets:[ { label:"Sugar", data: sugarData } ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        plugins:{ legend:{ labels:{ color:textCol } } },
        scales:{
          x:{ ticks:{ color:textCol }, grid:{ color:gridCol } },
          y:{ ticks:{ color:textCol }, grid:{ color:gridCol } }
        }
      }
    });

  } catch(e){
    setStatus("Trends error: " + (e?.message || "unknown"));
  }
}
/* ================= EXPORT ================= */

function formatISTNow(){
  return new Date().toLocaleString("en-IN", {
    timeZone: "Asia/Kolkata",
    dateStyle: "medium",
    timeStyle: "short"
  });
}

function setExportUI(isWorking, msg){
  const btn = document.getElementById("exportBtn");
  const status = document.getElementById("exportStatus");
  if(btn) btn.disabled = isWorking;
  if(status) status.textContent = msg || "";
}

function getBPString(entry){
  if(!entry) return "";
  const sys = entry.sys || "";
  const dia = entry.dia || "";
  const pulse = entry.pulse || "";
  if(!sys && !dia && !pulse) return "";
  let s = "";
  if(sys && dia) s = `${sys}/${dia}`;
  else if(sys || dia) s = `${sys}${dia ? "/" + dia : ""}`;
  if(pulse) s += (s ? " " : "") + `(Pulse ${pulse})`;
  return s.trim();
}

function getSugarString(entry){
  if(!entry) return "";
  const v = entry.value || "";
  return v ? String(v) : "";
}

async function exportToPDF(){
  try{
    setExportUI(true, "Preparing data…");

    const snap = await db.collection("boards")
      .doc(BOARD_ID)
      .collection("days")
      .orderBy(firebase.firestore.FieldPath.documentId())
      .startAt(EXPORT_START_DATE)
      .endAt(selectedDate)
      .get();

    const days = [];
    snap.forEach(doc => days.push({ date: doc.id, data: doc.data() || {} }));

    if(!days.find(d => d.date === selectedDate)){
      days.push({ date: selectedDate, data: {} });
    }

    days.sort((a,b)=> a.date.localeCompare(b.date));

    setExportUI(true, `Generating PDF (${days.length} day(s))…`);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const marginX = 40;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const usableWidth = pageWidth - marginX*2;

    const dash = "—";

    doc.setFontSize(16);
    doc.text("Dharini Checklist Report", marginX, 50);

    doc.setFontSize(10);
    doc.text(`Range: ${EXPORT_START_DATE} to ${selectedDate} (IST)`, marginX, 70);
    doc.text(`Generated: ${formatISTNow()}`, marginX, 85);

    let y = 110;

    const ROWS = [
      { label: "Before Breakfast",      bpId: "bb_bp", sugarId: "bb_sugar" },
      { label: "Before Lunch",          bpId: "bl_bp", sugarId: "bl_sugar" },
      { label: "Before Dinner",         bpId: "bd_bp", sugarId: "bd_sugar" },
      { label: "2 Hours After Dinner",  bpId: "2h_bp", sugarId: "2h_sugar" }
    ];

    function bpCell(data, bpId){
      const entry = data?.[bpId] || {};
      const s = getBPString(entry);
      return s ? s : dash;
    }

    function sugarCell(data, sugarId){
      const entry = data?.[sugarId] || {};
      const s = getSugarString(entry);
      return s ? s : dash;
    }

    function ensureSpace(minSpace){
      if(y + minSpace > pageHeight - 50){
        doc.addPage();
        y = 60;
      }
    }

    for(const day of days){
      ensureSpace(240);

      doc.setFontSize(12);
      doc.text("Date", marginX, y);
      y += 18;

      doc.setFontSize(14);
      doc.text(day.date, marginX, y);
      y += 10;

      const data = day.data || {};
      const body = ROWS.map(r => ([
        r.label,
        bpCell(data, r.bpId),
        sugarCell(data, r.sugarId)
      ]));

      doc.autoTable({
        startY: y + 8,
        head: [["", "Blood Pressure", "Sugar"]],
        body,
        theme: "grid",
        styles: {
          fontSize: 11,
          cellPadding: 10,
          overflow: "linebreak",
          valign: "middle"
        },
        headStyles: {
          fillColor: [245, 245, 245],
          textColor: 20,
          fontStyle: "bold"
        },
        columnStyles: {
          0: { cellWidth: usableWidth * 0.34 },
          1: { cellWidth: usableWidth * 0.33 },
          2: { cellWidth: usableWidth * 0.33 }
        },
        margin: { left: marginX, right: marginX }
      });

      y = doc.lastAutoTable.finalY + 18;

      ensureSpace(90);
      doc.setFontSize(12);
      doc.text("Comments:", marginX, y);

      const comments = (data.__comments || "").trim();
      const commentText = comments ? comments : dash;

      doc.setFontSize(11);
      const lines = doc.splitTextToSize(commentText, usableWidth);
      doc.text(lines, marginX, y + 16);

      y = y + 16 + (lines.length * 14) + 26;
    }

    const filename = `Dharini_Report_${EXPORT_START_DATE}_to_${selectedDate}.pdf`;
    doc.save(filename);

    setExportUI(false, "Done");
    setTimeout(()=>setExportUI(false,""), 2000);

  } catch(err){
    setExportUI(false, "Export failed. Check internet and try again.");
  }
}

/* ================= BOOT ================= */

document.getElementById("datePicker").onchange = e=>{
  selectedDate = e.target.value;
  loadDay();
};

applyTheme(getSavedTheme());
wireCommentsAutosave();
loadDay();
</script>

</body>
</html>
