<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dharini Daily Checklist</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<style>
body{font-family:system-ui;background:#f6f7fb;margin:0;padding:16px}
h2{margin-top:0}
.nav{margin-bottom:16px}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
.blockTitle{font-weight:900;margin-bottom:10px}
.task{margin-bottom:12px}
input{padding:6px;border-radius:6px;border:1px solid #ddd;margin:4px}
button{padding:6px 10px;border-radius:6px;border:0;background:#2f6fed;color:#fff;font-weight:700}
.progress{height:8px;background:#e8eaf2;border-radius:999px;overflow:hidden;margin-bottom:8px}
.progress div{height:100%;background:#2f6fed;width:0%}
</style>
</head>

<body>

<h2>Dharini Daily Checklist</h2>

<div class="nav">
<button onclick="shiftDay(-1)">◀ Previous</button>
<input type="date" id="datePicker">
<button onclick="shiftDay(1)">Next ▶</button>
</div>

<div class="progress"><div id="bar"></div></div>
<div id="percent"></div>

<div id="app"></div>

<div class="card">
<h3>Trends (Last 30 Days)</h3>
<canvas id="bpChart"></canvas>
<canvas id="sugarChart"></canvas>
</div>

<script>

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAxjeAx9iMHomGppnnouaJ5ISR3AthNEvU",
  authDomain: "dharini-checklist-sync.firebaseapp.com",
  projectId: "dharini-checklist-sync",
  storageBucket: "dharini-checklist-sync.firebasestorage.app",
  messagingSenderId: "428971704286",
  appId: "1:428971704286:web:bd52c5bb86c9ed3725674f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= SETTINGS ================= */

const BOARD_ID="dharini-global-board";
const TIMEZONE="Asia/Kolkata";
const CEFHUM_END="2026-02-20";
let selectedDate=getISTDate();

/* ================= HELPERS ================= */

function getISTDate(dateObj=null){
  const now=dateObj||new Date();
  const ist=new Date(now.toLocaleString("en-US",{timeZone:TIMEZONE}));
  return ist.toISOString().split("T")[0];
}

function shiftDay(days){
  const d=new Date(selectedDate);
  d.setDate(d.getDate()+days);
  selectedDate=getISTDate(d);
  loadDay();
}

function afterEnd(date){return date>CEFHUM_END;}
function isSunday(date){return new Date(date).getDay()===0;}

/* ================= FULL CHECKLIST ================= */

const blocks=[
{
title:"Before Breakfast",
tasks:[
{id:"bb_bp",text:"Measure BP",type:"bp"},
{id:"bb_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bb_novo10",text:"Novorapid 10u"},
{id:"bb_panD",text:"Pan D"}
]},
{
title:"After Breakfast",
tasks:[
{id:"ab_cefhum",text:"Cefhum",show:(d)=>!afterEnd(d)},
{id:"ab_metxl",text:"Met XL"},
{id:"ab_nikoran",text:"Nikoran"},
{id:"ab_lasilactone",text:"Lasilactone"},
{id:"ab_cobadex",text:"Cobadex"},
{id:"ab_folic",text:"Folic Acid"},
{id:"ab_ivabred",text:"Ivabred"},
{id:"ab_dolo",text:"Dolo (optional)"},
{id:"ab_vitd",text:"Vit D (Sunday only)",show:(d)=>isSunday(d)}
]},
{
title:"Before Lunch",
tasks:[
{id:"bl_bp",text:"Measure BP",type:"bp"},
{id:"bl_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bl_novo12",text:"Novorapid 12u"}
]},
{
title:"After Lunch",
tasks:[
{id:"al_ecosprin",text:"Ecosprin"},
{id:"al_clopitab",text:"Clopitab"}
]},
{
title:"Before Dinner",
tasks:[
{id:"bd_bp",text:"Measure BP",type:"bp"},
{id:"bd_sugar",text:"Measure Sugar",type:"sugar"},
{id:"bd_novo7",text:"Novorapid 7u"}
]},
{
title:"After Dinner Meds",
tasks:[
{id:"ad_cefhum",text:"Cefhum",show:(d)=>!afterEnd(d)},
{id:"ad_halfmet",text:"½ Met XL"},
{id:"ad_nikoran",text:"Nikoran"},
{id:"ad_ivabred",text:"Ivabred"}
]},
{
title:"2 Hours After Dinner",
tasks:[
{id:"2h_bp",text:"Measure BP",type:"bp"},
{id:"2h_sugar",text:"Measure Sugar",type:"sugar"},
{id:"2h_tresiba",text:"Tresiba 16u"},
{id:"2h_dolo",text:"Dolo (if pain)"},
{id:"2h_rosuva",text:"Rosuvastatin"}
]}
];

/* ================= LOAD DAY ================= */

let unsubscribe=null;

function loadDay(){

  if(unsubscribe)unsubscribe();

  document.getElementById("datePicker").value=selectedDate;

  const docRef=db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .doc(selectedDate);

  unsubscribe=docRef.onSnapshot(doc=>{
    render(doc.data()||{},docRef);
  });

  loadTrends();
}

/* ================= RENDER ================= */

function render(data,docRef){

  const app=document.getElementById("app");
  app.innerHTML="";
  let total=0,done=0;

  blocks.forEach(block=>{
    const card=document.createElement("div");
    card.className="card";

    const title=document.createElement("div");
    title.className="blockTitle";
    title.textContent=block.title;
    card.appendChild(title);

    block.tasks.forEach(task=>{
      if(task.show && !task.show(selectedDate))return;

      total++;
      const row=document.createElement("div");
      row.className="task";

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked=data?.[task.id]?.done||false;
      if(cb.checked)done++;

      cb.onchange=()=>{
        docRef.set({
          [task.id]:{...data?.[task.id],done:cb.checked}
        },{merge:true});
      };

      row.appendChild(cb);
      row.append(" "+task.text);

      if(task.type==="bp"){
        const sys=document.createElement("input");
        sys.placeholder="Sys";
        sys.value=data?.[task.id]?.sys||"";

        const dia=document.createElement("input");
        dia.placeholder="Dia";
        dia.value=data?.[task.id]?.dia||"";

        const save=document.createElement("button");
        save.textContent="Save BP";
        save.onclick=()=>{
          docRef.set({
            [task.id]:{
              done:true,
              sys:parseInt(sys.value)||"",
              dia:parseInt(dia.value)||""
            }
          },{merge:true});
        };

        row.appendChild(document.createElement("br"));
        row.appendChild(sys);
        row.appendChild(dia);
        row.appendChild(save);
      }

      if(task.type==="sugar"){
        const val=document.createElement("input");
        val.placeholder="Sugar";
        val.value=data?.[task.id]?.value||"";

        const save=document.createElement("button");
        save.textContent="Save Sugar";
        save.onclick=()=>{
          docRef.set({
            [task.id]:{
              done:true,
              value:parseFloat(val.value)||""
            }
          },{merge:true});
        };

        row.appendChild(document.createElement("br"));
        row.appendChild(val);
        row.appendChild(save);
      }

      card.appendChild(row);
    });

    app.appendChild(card);
  });

  const percent=Math.round((done/total)*100)||0;
  document.getElementById("bar").style.width=percent+"%";
  document.getElementById("percent").textContent=
    percent+"% Complete ("+selectedDate+")";
}

/* ================= TRENDS ================= */

async function loadTrends(){

  const snapshot=await db.collection("boards")
    .doc(BOARD_ID)
    .collection("days")
    .orderBy(firebase.firestore.FieldPath.documentId())
    .limitToLast(30)
    .get();

  const labels=[];
  const sys=[];
  const dia=[];
  const sugar=[];

  snapshot.forEach(doc=>{
    const d=doc.data();
    labels.push(doc.id);
    sys.push(d?.bb_bp?.sys||null);
    dia.push(d?.bb_bp?.dia||null);
    sugar.push(d?.bb_sugar?.value||null);
  });

  new Chart(document.getElementById("bpChart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Systolic",data:sys,borderColor:"red"},
        {label:"Diastolic",data:dia,borderColor:"blue"}
      ]
    }
  });

  new Chart(document.getElementById("sugarChart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Sugar",data:sugar,borderColor:"green"}
      ]
    }
  });
}

document.getElementById("datePicker").onchange=e=>{
  selectedDate=e.target.value;
  loadDay();
};

loadDay();

</script>

</body>
</html>
